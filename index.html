<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) {
            .chat-container { height: calc(100vh - 200px); }
        }
        .preserve-lines { white-space: pre-wrap; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ייבוא ספריות Firebase מ-CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, serverTimestamp, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- הגדרות ---
        
        // הגדרות Firebase (הכנסתי את הפרטים ששלחת)
        const firebaseConfig = {
  apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
  authDomain: "cholar-bubbles.firebaseapp.com",
  projectId: "cholar-bubbles",
  storageBucket: "cholar-bubbles.firebasestorage.app",
  messagingSenderId: "965320932006",
  appId: "1:965320932006:web:eeeefce099c0422d4e9267",
  measurementId: "G-Q08F6MFNCD"
};
        
        // --- חשוב! הכנס כאן את מפתח ה-Gemini שלך ---
        const apiKey = "AIzaSyBd_Xcsgz-l3azRFhoczpiWUGEomx2wlgI"; 
        // ---------------------------------------------

        // אתחול Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // חשיפה לשימוש ב-Component
        window.fbFunctions = {
            signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
            doc, setDoc, updateDoc, deleteDoc, arrayUnion, serverTimestamp, getDoc, 
            collection, addDoc, onSnapshot, query, orderBy
        };
        window.fbAuth = auth;
        window.fbDb = db;

        // --- רכיבים ---

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className}></i>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text
                .replace(/\*\*/g, '')
                .replace(/###/g, '')
                .replace(/#/g, '')
                .replace(/^שלום!|^בהחלט!|^הנה הפסקה המלוטשת:|^להלן התוכן:|^לסיכום,/g, '')
                .replace(/json/g, '')
                .replace(/```/g, '')
                .trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': {
                label: 'בית ספר יסודי (ד\'-ו\')',
                prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה.'
            },
            'middle-school': { 
                label: 'חטיבת ביניים', 
                prompt: 'חשוב ביותר: כתוב ברמת תלמיד בגיל 16 שכותב עבודה להגשה. הכתיבה צריכה להיות טבעית, זורמת ומכובדת, שפה תקנית אך לא "אקדמית" מידי.' 
            },
            'high-school': { 
                label: 'תיכון', 
                prompt: 'חשוב ביותר: תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18 (עבודת גמר בתיכון). רמה גבוהה, תקנית ועשירה, מבנה לוגי מורכב.' 
            },
            'academic': { 
                label: 'אקדמי', 
                prompt: 'כתוב בשפה אקדמית מלאה וגבוהה. השתמש בטרמינולוגיה מחקרית, משפטים מורכבים וניסוחים אובייקטיביים.' 
            }
        };

        const INITIAL_DATA = {
            'תקציר': [
                { id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' },
                { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' },
                { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' },
                { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' },
                { id: 'abs-sum', title: 'פסקה מסכמת לתקציר', rawInput: '', refinedContent: '' }
            ],
            'מבוא': [
                { id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' },
                { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' },
                { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' },
                { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' },
                { id: 'intro-sum', title: 'לסיכום המבוא ומבנה העבודה', rawInput: '', refinedContent: '' }
            ],
            'גוף העבודה': [
                { id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' },
                { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' },
                { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' },
                { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' },
                { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' },
                { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' },
                { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' },
                { id: 'body-sum', title: 'לסיכום פרק גוף העבודה', rawInput: '', refinedContent: '' }
            ],
            'ממצאים': [
                { id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' },
                { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' },
                { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' },
                { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' },
                { id: 'res-sum', title: 'לסיכום פרק הממצאים', rawInput: '', refinedContent: '' }
            ],
            'סיכום': [
                { id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' },
                { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' },
                { id: 'conc-sum', title: 'דברי סיום', rawInput: '', refinedContent: '' }
            ],
            'ביבליוגרפיה': []
        };

        const WelcomeScreen = ({ onSelect }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-6 text-right">
                <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="max-w-4xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
                    <div className="md:w-1/2 bg-indigo-600 p-12 text-white flex flex-col justify-center items-center md:items-start">
                        <Icon name="book-open" size={48} className="mb-6" />
                        <h1 className="text-4xl font-black mb-4">ScholarBubbles</h1>
                        <p className="text-indigo-100 text-lg">פלטפורמה חכמה לכתיבת עבודות מחקר.</p>
                    </div>
                    <div className="md:w-1/2 p-12 bg-white flex flex-col justify-center">
                        <h2 className="text-xl font-bold mb-8 text-slate-800">בחר/י את רמת הכתיבה:</h2>
                        <div className="space-y-4">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button key={key} onClick={() => onSelect(key)} className="w-full text-right p-6 rounded-2xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition-all group flex items-center justify-between">
                                    <span className="font-bold text-lg text-slate-900">{info.label}</span>
                                    <Icon name="chevron-left" className="text-slate-300 group-hover:text-indigo-500" />
                                </button>
                            ))}
                        </div>
                    </div>
                </motion.div>
            </div>
        );

        function App() {
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projectsList, setProjectsList] = useState([]);
            
            // שימור נתונים - צ'אט שאלת מחקר וצ'אט מקורות
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [searchState, setSearchState] = useState({ query: '', results: [], loading: false });

            const sections = ['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'];

            const handleUpdate = (id, updates) => {
                setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, ...updates} : b) }));
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                const previousContent = allData[view]
                    .slice(0, allData[view].findIndex(b => b.id === id))
                    .map(b => b.refinedContent)
                    .filter(Boolean)
                    .join("\n\n");

                handleUpdate(id, { isRefining: true });
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `הנושא: ${paperTitle}. הפרק: ${view}. רמה: ${WRITING_LEVELS[level].label}.
                            
                            טקסט קודם רציף בפרק זה (להמשכיות):
                            ${previousContent || "זוהי תחילת הפרק"}

                            מידע גולמי לבועה זו:
                            "${bubble.rawInput}"
                            
                            משימה:
                            כתוב פסקה אקדמית מלאה, עשירה ומורחבת מאוד (לפחות 200 מילים) על בסיס המידע הגולמי.
                            
                            הנחיות קריטיות:
                            1. הרחב מאוד את הנקודות. אל תכתוב בקצרה.
                            2. כתוב כהמשך ישיר לטקסט הקודם. בלי פתיחות כמו "בפסקה זו" ובלי סיומות כמו "לסיכום".
                            3. חלק לפסקאות פנימיות אם הטקסט ארוך.
                            4. אל תשתמש בכוכביות.` }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || "Unknown error");
                    }

                    const resJson = await response.json();
                    const text = resJson.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    handleUpdate(id, { refinedContent: cleanMarkdown(text), isRefining: false });
                } catch (e) { 
                    alert(`שגיאה ב-AI: ${e.message}\nאנא בדוק שהמפתח (API Key) תקין ומגודר בקוד.`);
                    handleUpdate(id, { isRefining: false }); 
                }
            };

            const searchAI = async (q) => {
                if (!q.trim()) return;
                setSearchState(prev => ({ ...prev, loading: true, query: q }));
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `חפש במאגרי מידע אקדמיים ומצא 4 מקורות קיימים ורלוונטיים עבור הנושא: "${q}". 
                            חובה להשתמש בכלי החיפוש כדי לאמת את קיום המקורות.
                            החזר את התשובה בפורמט JSON בלבד: [{"title": "שם המאמר", "author": "שמות כותבים", "year": "שנה", "summary": "תקציר קצר", "link": "קישור גוגל סקולר או ישיר"}]` }] }],
                            tools: [{ "google_search": {} }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await response.json();
                    const jsonStr = data.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
                    const results = JSON.parse(jsonStr);
                    setSearchState(prev => ({ ...prev, results, loading: false }));
                } catch (e) { setSearchState(prev => ({ ...prev, loading: false })); }
            };

            const downloadAsWord = () => {
                const styles = `
                    <style>
                        @page { size: A4; margin: 2.54cm; }
                        body { 
                            direction: rtl; 
                            text-align: right; 
                            font-family: 'David', 'Times New Roman', serif; 
                            font-size: 12pt; 
                            line-height: 1.5; 
                        }
                        h1 { text-align: center; font-size: 18pt; margin-bottom: 2cm; font-weight: bold; }
                        h2 { font-size: 14pt; font-weight: bold; margin-top: 1cm; margin-bottom: 0.5cm; font-weight: bold; border-bottom: 1px solid #000; }
                        p { margin-bottom: 0.4cm; text-align: justify; }
                    </style>
                `;
                let content = `<html><head><meta charset='utf-8'>${styles}</head><body dir="RTL">`;
                content += `<h1>${paperTitle}</h1>`;
                sections.forEach(sec => {
                    const bubbles = allData[sec];
                    if (bubbles?.some(b => b.refinedContent)) {
                        content += `<h2>${sec}</h2>`;
                        bubbles.forEach(b => {
                            if (b.refinedContent) content += `<p>${b.refinedContent.replace(/\n/g, '<br>')}</p>`;
                        });
                    }
                });
                content += `</body></html>`;
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${paperTitle}.doc`;
                link.click();
            };
            
            // ניהול פרויקטים ב-Firebase
            const [user, setUser] = useState(null);
            
            useEffect(() => {
                window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                    setUser(u);
                    if (u) loadProjectsList(u.uid);
                });
            }, []);

            const loadProjectsList = (uid) => {
                const q = window.fbFunctions.query(
                    window.fbFunctions.collection(window.fbDb, "users", uid, "projects"),
                    window.fbFunctions.orderBy("lastUpdated", "desc")
                );
                window.fbFunctions.onSnapshot(q, (snapshot) => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjectsList(projects);
                    if (projects.length > 0 && !currentProjectId) {
                        // Load latest only if not already editing
                        loadProject(projects[0]);
                    }
                });
            };

            const loadProject = (project) => {
                setCurrentProjectId(project.id);
                setPaperTitle(project.paperTitle);
                setAllData(project.allData || INITIAL_DATA);
                if (project.level) setLevel(project.level);
            };
            
            const deleteProject = async (e, projectId) => {
                e.stopPropagation(); // מונע טעינה של הפרויקט בעת המחיקה
                if (!confirm("האם אתה בטוח שברצונך למחוק את העבודה הזו?")) return;
                
                try {
                    await window.fbFunctions.deleteDoc(
                        window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", projectId)
                    );
                    // אם מחקנו את הפרויקט הנוכחי, נאפס
                    if (projectId === currentProjectId) {
                        createNewProject();
                    }
                } catch (err) {
                    alert("שגיאה במחיקה: " + err.message);
                }
            };

            const createNewProject = () => {
                setCurrentProjectId(null);
                setPaperTitle('עבודה חדשה');
                setAllData(INITIAL_DATA);
                setLevel(null);
            };

            // שמירה אוטומטית
            useEffect(() => {
                if (!user || !level) return;
                const timeoutId = setTimeout(() => saveUserData(), 2000);
                return () => clearTimeout(timeoutId);
            }, [allData, paperTitle, level]);

            const saveUserData = async () => {
                if (!user) return;
                try {
                    const projectData = {
                        paperTitle,
                        allData,
                        level,
                        lastUpdated: window.fbFunctions.serverTimestamp()
                    };
                    if (currentProjectId) {
                        await window.fbFunctions.updateDoc(
                            window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", currentProjectId),
                            projectData
                        );
                    } else {
                        const docRef = await window.fbFunctions.addDoc(
                            window.fbFunctions.collection(window.fbDb, "users", user.uid, "projects"),
                            projectData
                        );
                        setCurrentProjectId(docRef.id);
                    }
                } catch (e) { console.error("Save Error:", e); }
            };

            // רכיב צ'אט
            const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false }) => {
                const [input, setInput] = useState('');
                const [loading, setLoading] = useState(false);
                const scrollRef = useRef(null);

                useEffect(() => {
                    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }, [messages]);

                const sendMessage = async () => {
                    if (!input.trim() || loading) return;
                    const userMsg = { role: 'user', text: input };
                    setMessages(prev => [...prev, userMsg]);
                    setInput('');
                    setLoading(true);

                    try {
                        const payload = {
                            contents: [...messages, userMsg].map(m => ({ role: m.role === 'ai' ? 'model' : 'user', parts: [{ text: m.text }] })),
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        };
                        if (withSearchTool) {
                            payload.tools = [{ google_search: {} }];
                        }

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "מצטער, שגיאה.";
                        
                        // קישורים
                        const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions;
                        if (grounding) {
                            aiText += "\n\nמקורות:\n";
                            grounding.forEach(g => {
                                if (g.web?.uri && g.web?.title) {
                                    aiText += `• [${g.web.title}](${g.web.uri})\n`;
                                }
                            });
                        }
                        setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(aiText) }]);
                    } catch (e) { setMessages(prev => [...prev, { role: 'ai', text: "שגיאה בתקשורת." }]); }
                    setLoading(false);
                };

                return (
                    <div className="chat-container bg-white rounded-2xl border overflow-hidden shadow-sm h-full">
                        <div className="p-4 border-b bg-slate-50">
                            <h2 className="text-xl font-black text-indigo-600 flex items-center gap-2">{title}</h2>
                            <p className="text-xs text-slate-500">{subTitle}</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-white" ref={scrollRef}>
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                    <div className={`max-w-[85%] p-3 rounded-2xl text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-slate-100 text-slate-800' : 'bg-indigo-50 text-indigo-900 border border-indigo-100'}`}>
                                        {m.text.split('\n').map((line, idx) => {
                                            const parts = line.split(/(\[(?:.*?)\]\((?:.*?)\)|https?:\/\/[^\s]+)/g);
                                            return <div key={idx}>{parts.map((part, pIdx) => {
                                                const mdLink = part.match(/\[(.*?)\]\((.*?)\)/);
                                                if (mdLink) return <a key={pIdx} href={mdLink[2]} target="_blank" className="text-blue-600 underline font-bold">{mdLink[1]}</a>;
                                                if (part.match(/^https?:\/\//)) return <a key={pIdx} href={part} target="_blank" className="text-blue-600 underline break-all">{part}</a>;
                                                return <span key={pIdx}>{part}</span>;
                                            })}</div>;
                                        })}
                                    </div>
                                </div>
                            ))}
                            {loading && <div className="text-xs text-slate-400 animate-pulse">מקליד...</div>}
                        </div>
                        <div className="p-3 bg-white border-t flex gap-2">
                            <input className="flex-1 px-4 py-2 border rounded-full text-sm outline-none" placeholder="כתוב כאן..." value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} />
                            <button onClick={sendMessage} className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center"><Icon name="send" size={16} /></button>
                        </div>
                    </div>
                );
            };

            // מסך התחברות
            if (!user) {
                return (
                    <div className="fixed inset-0 bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-3xl text-center max-w-md w-full">
                            <h2 className="text-2xl font-black mb-4">כניסה למערכת</h2>
                            <p className="text-sm mb-6">התחבר כדי לשמור ולנהל את העבודות שלך.</p>
                            <button onClick={() => {
                                const provider = new window.fbFunctions.GoogleAuthProvider();
                                window.fbFunctions.signInWithPopup(window.fbAuth, provider).catch(e => alert("שגיאה בהתחברות: " + e.message));
                            }} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold w-full">התחבר עם Google</button>
                        </div>
                    </div>
                );
            }

            if (!level) return <WelcomeScreen onSelect={setLevel} />;

            return (
                <div className="flex h-screen overflow-hidden bg-white">
                    <aside className="w-64 bg-slate-900 text-white p-6 flex flex-col z-10 shadow-xl">
                        <div className="mb-8 cursor-pointer" onClick={() => setLevel(null)}>
                            <h1 className="text-xl font-bold flex items-center gap-3"><Icon name="book-open" className="text-indigo-400" /> ScholarBubbles</h1>
                            <div className="text-[10px] mt-2 bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded inline-block">רמת {WRITING_LEVELS[level].label}</div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-xs font-bold text-slate-500 uppercase mb-2 flex justify-between">
                                העבודות שלי
                                <button onClick={createNewProject} className="text-indigo-400 hover:text-white"><Icon name="plus" size={14}/></button>
                            </h3>
                            <div className="space-y-1 max-h-40 overflow-y-auto">
                                {projectsList.map(p => (
                                    <div key={p.id} className={`group flex items-center justify-between p-2 rounded text-xs ${currentProjectId === p.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}`}>
                                        <button onClick={() => loadProject(p)} className="truncate w-full text-right">{p.paperTitle || 'ללא כותרת'}</button>
                                        <button onClick={(e) => deleteProject(e, p.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 px-1"><Icon name="trash-2" size={12}/></button>
                                    </div>
                                ))}
                                {projectsList.length === 0 && <span className="text-xs text-slate-600">אין עבודות שמורות</span>}
                            </div>
                        </div>

                        <nav className="flex-1 space-y-1 overflow-y-auto">
                            <button onClick={() => setView('question')} className={`w-full text-right p-3 rounded-xl text-sm mb-2 border border-slate-700 flex items-center gap-2 ${view === 'question' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="help-circle" size={14}/> שאלת מחקר AI</button>
                            <button onClick={() => setView('search')} className={`w-full text-right p-3 rounded-xl text-sm mb-6 border border-slate-700 flex items-center gap-2 ${view === 'search' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="search" size={14}/> חיפוש מקורות AI</button>
                            
                            <div className="text-[10px] text-slate-500 font-bold uppercase mb-2 mr-2">כתיבת העבודה</div>
                            {sections.map(s => (
                                <button key={s} onClick={() => setView(s)} className={`w-full text-right flex items-center justify-between p-3 rounded-xl text-sm transition-all ${view === s ? 'bg-indigo-600 font-bold' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>
                                    {s}
                                    {allData[s]?.some(b => b.refinedContent) && <Icon name="check-circle" size={14} className="text-emerald-400" />}
                                </button>
                            ))}
                        </nav>
                        <button onClick={downloadAsWord} className="mt-6 bg-emerald-600 text-white p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-emerald-700">
                            <Icon name="download" size={14} /> הורדה כקובץ Word
                        </button>
                    </aside>

                    <main className="flex-1 flex overflow-hidden">
                        <section className="flex-1 p-8 overflow-y-auto border-l bg-slate-50/30">
                            <div className="max-w-3xl mx-auto h-full flex flex-col">
                                <div className="mb-6 p-4 bg-white border border-indigo-100 rounded-2xl shadow-sm">
                                    <label className="text-[10px] uppercase font-bold text-indigo-400 block mb-1">נושא העבודה</label>
                                    <input className="w-full bg-transparent text-xl font-black text-slate-800 outline-none" value={paperTitle} onChange={(e) => setPaperTitle(e.target.value)} />
                                </div>

                                {view === 'question' ? (
                                    <AIChatComponent 
                                        title="גיבוש שאלת מחקר" 
                                        subTitle="אני אעזור לך לחדד ולנסח את שאלת המחקר המדויקת ביותר."
                                        messages={questionChatMessages}
                                        setMessages={setQuestionChatMessages}
                                        systemPrompt={`אתה מנחה אקדמי. עזור לסטודנט לנסח שאלת מחקר אחת ברורה. תשובות קצרות וממוקדות.`}
                                    />
                                ) : view === 'search' ? (
                                    <AIChatComponent 
                                        title="חיפוש מקורות חכם" 
                                        subTitle="בקש ממני למצוא מקורות בנושא מסוים."
                                        messages={sourceChatMessages}
                                        setMessages={setSourceChatMessages}
                                        withSearchTool={true}
                                        systemPrompt={`מצא מקורות מידע וקישורים ישירים. תן תיאור של משפט אחד לכל מקור.`}
                                    />
                                ) : (
                                    <div className="pb-20">
                                        <h2 className="text-3xl font-black mb-6 text-slate-900 px-2">{view}</h2>
                                        {allData[view]?.map(b => (
                                            <div key={b.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 hover:shadow-md transition-all">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className={`font-bold text-xs uppercase tracking-wider ${b.id.includes('sum') ? 'text-indigo-600' : 'text-slate-400'}`}>{b.title}</span>
                                                    <button onClick={() => {
                                                        if(confirm("למחוק?")) setAllData(prev => ({...prev, [view]: prev[view].filter(x => x.id !== b.id)}));
                                                    }} className="text-red-300 hover:text-red-500"><Icon name="trash-2" size={14} /></button>
                                                </div>
                                                <textarea 
                                                    className="w-full min-h-[100px] p-4 rounded-xl bg-slate-50 text-sm leading-relaxed outline-none border border-transparent focus:border-indigo-300 focus:bg-white transition-all resize-none mb-4" 
                                                    value={b.rawInput} 
                                                    onChange={e => handleUpdate(b.id, {rawInput: e.target.value})} 
                                                    placeholder="כתוב כאן נקודות, רעיונות או טיוטה ראשונית..." 
                                                />
                                                <div className="flex justify-end">
                                                    <button onClick={() => handleRefine(b.id)} disabled={b.isRefining || !b.rawInput.trim()} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-md shadow-indigo-100 disabled:opacity-50 disabled:shadow-none">
                                                        {b.isRefining ? <div className="w-4 h-4 border-2 border-white border-t-transparent animate-spin rounded-full" /> : <Icon name="sparkles" size={16} />}
                                                        {b.isRefining ? 'כותב בהרחבה...' : 'הרחב וסגנן עם AI'}
                                                    </button>
                                                </div>
                                                {b.refinedContent && (
                                                    <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100 text-sm leading-relaxed text-slate-800 whitespace-pre-wrap">
                                                        {b.refinedContent}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        <button 
                                            onClick={() => {
                                                const newId = `${view}-${Date.now()}`;
                                                setAllData(prev => ({
                                                    ...prev,
                                                    [view]: [...(prev[view] || []), { id: newId, title: view === 'ביבליוגרפיה' ? 'מקור חדש' : 'פסקה חדשה', rawInput: '', refinedContent: '' }]
                                                }));
                                            }}
                                            className="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold hover:border-indigo-500 hover:text-indigo-600 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Icon name="plus" size={20} />
                                            הוסף {view === 'ביבליוגרפיה' ? 'מקור' : 'פסקה'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </section>

                        {/* Preview Area */}
                        <section className="w-[45%] bg-white p-12 overflow-y-auto border-r shadow-inner hidden md:block">
                             <div className="max-w-[21cm] mx-auto min-h-[29.7cm] font-serif" dir="rtl" style={{fontFamily: "'David', 'Times New Roman', serif"}}>
                                <h3 className="text-center font-bold border-b-2 border-black pb-4 mb-8 text-xl md:text-2xl text-black">{paperTitle}</h3>
                                {sections.map(sec => {
                                    const bubbles = allData[sec];
                                    if (!bubbles?.some(b => b.refinedContent)) return null;
                                    return (
                                        <div key={sec} className="mb-8">
                                            <h4 className="font-bold text-lg mb-4 text-black underline">{sec}</h4>
                                            {bubbles.map(b => b.refinedContent && (
                                                <div key={b.id} className="text-[12pt] leading-[1.5] text-black mb-4 text-justify preserve-lines">
                                                    {b.refinedContent}
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                             </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
