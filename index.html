<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
          authDomain: "cholar-bubbles.firebaseapp.com",
          projectId: "cholar-bubbles",
          storageBucket: "cholar-bubbles.firebasestorage.app",
          messagingSenderId: "965320932006",
          appId: "1:965320932006:web:eeeefce099c0422d4e9267",
          measurementId: "G-Q08F6MFNCD"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            
            window.fbFunctions = {
                signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
                signInAnonymously, doc, setDoc, updateDoc, deleteDoc, arrayUnion, 
                serverTimestamp, getDoc, collection, addDoc, onSnapshot,
                query, orderBy
            };
            window.firebaseInitialized = true;
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) { .chat-container { height: calc(100vh - 200px); } }
        .preserve-lines { white-space: pre-wrap; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useCallback } = React;
        const MotionLib = window.Motion || { motion: { div: 'div' }, AnimatePresence: ({children}) => <>{children}</> };
        const { motion, AnimatePresence } = MotionLib;

        // No hardcoded API key here - security best practice
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                const pascalName = name.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
                const iconDef = window.lucide.icons ? window.lucide.icons[pascalName] : null;
                if (iconDef && window.lucide.createElement) {
                    ref.current.innerHTML = '';
                    const svg = window.lucide.createElement(iconDef);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    if (className) svg.setAttribute('class', className);
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-block', width: size, height: size }}></span>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text.replace(/\*\*/g, '').replace(/###/g, '').replace(/#/g, '').replace(/json/g, '').replace(/```/g, '').trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': { label: 'בית ספר יסודי (ד\'-ו\')', prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה.' },
            'middle-school': { label: 'חטיבת ביניים', prompt: 'תכתוב ברמת תלמיד בגיל 16 שכותב עבודה להגשה.' },
            'high-school': { label: 'תיכון', prompt: 'תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18.' },
            'academic': { label: 'אקדמי', prompt: 'כתוב בשפה אקדמית מלאה וגבוהה.' }
        };

        const INITIAL_DATA = {
            'תקציר': [{ id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' }, { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' }, { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' }, { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' }],
            'מבוא': [{ id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' }, { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' }, { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' }, { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' }],
            'גוף העבודה': [{ id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' }, { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' }, { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' }, { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' }, { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' }, { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' }, { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' }],
            'ממצאים': [{ id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' }, { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' }, { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' }, { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' }],
            'סיכום': [{ id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' }, { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' }],
            'ביבליוגרפיה': []
        };

        const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false, user, trackAction }) => {
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || loading) return;
                const userMsg = { role: 'user', text: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setLoading(true);
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [...messages, userMsg], 
                            systemPrompt: systemPrompt,
                            withSearch: withSearchTool
                        })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(data.text) }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'ai', text: "שגיאה בחיבור לשרת ה-AI." }]);
                }
                setLoading(false);
            };

            return (
                <div className="chat-container bg-white rounded-2xl border overflow-hidden shadow-sm h-full flex flex-col">
                    <div className="p-4 border-b bg-slate-50">
                        <h2 className="text-xl font-black text-indigo-600">{title}</h2>
                        <p className="text-xs text-slate-500">{subTitle}</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${m.role === 'user' ? 'bg-slate-100' : 'bg-indigo-50 border border-indigo-100'}`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="p-3 bg-white border-t flex gap-2">
                        <input className="flex-1 px-4 py-2 border rounded-full text-sm outline-none" placeholder="כתוב כאן..." value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} />
                        <button onClick={sendMessage} className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center"><Icon name="send" size={16} /></button>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [error, setError] = useState('');

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                const { signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.fbFunctions;
                try {
                    let result = isRegistering 
                        ? await createUserWithEmailAndPassword(window.fbAuth, email, password)
                        : await signInWithEmailAndPassword(window.fbAuth, email, password);
                    onAuthSuccess(result.user);
                } catch (err) { setError('שגיאה בהתחברות'); }
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-3xl text-center max-w-md w-full shadow-2xl">
                        <h2 className="text-2xl font-black mb-6">כניסה ל-ScholarBubbles</h2>
                        <form onSubmit={handleEmailAuth} className="space-y-4">
                            <input type="email" placeholder="אימייל" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            <input type="password" placeholder="סיסמה" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            {error && <p className="text-red-500 text-xs">{error}</p>}
                            <button type="submit" className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold">{isRegistering ? 'הרשמה' : 'כניסה'}</button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="mt-4 text-xs text-indigo-500 underline">{isRegistering ? 'יש לך חשבון? התחבר' : 'אין לך חשבון? הירשם'}</button>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [loadingAuth, setLoadingAuth] = useState(true);

            useEffect(() => {
                const check = () => {
                    if (window.fbAuth) {
                        window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                            setUser(u);
                            setLoadingAuth(false);
                        });
                    } else { setTimeout(check, 500); }
                };
                check();
            }, []);

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, isRefining: true} : b) }));

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            messages: [{ role: 'user', text: `הפוך את הנקודות הבאות לפסקה אקדמית ברמת ${WRITING_LEVELS[level].label}: ${bubble.rawInput}` }],
                            systemPrompt: "אתה עורך אקדמי.",
                            withSearch: false
                        })
                    });
                    const res = await response.json();
                    setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, refinedContent: res.text, isRefining: false} : b) }));
                } catch (e) {
                    setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, isRefining: false} : b) }));
                }
            };

            if (loadingAuth) return <div className="h-screen flex items-center justify-center text-indigo-600">טוען...</div>;
            if (!user) return <AuthScreen onAuthSuccess={setUser} />;
            if (!level) return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center">
                    <div className="bg-white p-10 rounded-3xl max-w-lg w-full text-center">
                        <h2 className="text-2xl font-black mb-6">בחר רמת כתיבה</h2>
                        <div className="grid gap-3">
                            {Object.entries(WRITING_LEVELS).map(([k,v]) => (
                                <button key={k} onClick={()=>setLevel(k)} className="p-4 border rounded-2xl hover:bg-indigo-50 font-bold">{v.label}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-white" dir="rtl">
                    <aside className="w-64 bg-slate-900 text-white p-6 flex flex-col">
                        <h1 className="text-xl font-bold mb-8 flex items-center gap-2"><Icon name="book-open" /> ScholarBubbles</h1>
                        <nav className="flex-1 space-y-2">
                            {['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'].map(s => (
                                <button key={s} onClick={() => setView(s)} className={`w-full text-right p-3 rounded-xl transition-colors ${view === s ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}>{s}</button>
                            ))}
                        </nav>
                        <button onClick={() => window.fbAuth.signOut()} className="mt-auto p-3 text-red-400 text-sm">התנתק</button>
                    </aside>
                    <main className="flex-1 flex overflow-hidden">
                        <section className="flex-1 p-10 overflow-y-auto">
                            <input className="text-3xl font-black mb-8 w-full border-none outline-none" value={paperTitle} onChange={e=>setPaperTitle(e.target.value)} />
                            <div className="space-y-6">
                                {allData[view]?.map(b => (
                                    <div key={b.id} className="bg-white border rounded-2xl p-6 shadow-sm">
                                        <h4 className="text-xs font-bold text-slate-400 mb-2 uppercase">{b.title}</h4>
                                        <textarea className="w-full h-24 p-4 bg-slate-50 rounded-xl resize-none outline-none mb-4" value={b.rawInput} onChange={e => setAllData(prev=>({...prev, [view]: prev[view].map(x=>x.id===b.id?{...x, rawInput:e.target.value}:x)}))} placeholder="כתוב כאן נקודות מרכזיות..." />
                                        <div className="flex justify-end">
                                            <button onClick={()=>handleRefine(b.id)} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2">
                                                {b.isRefining ? 'כותב...' : <><Icon name="sparkles" size={16}/> סגנן עם AI</>}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                        <section className="w-1/3 bg-slate-50 border-r p-10 overflow-y-auto font-serif shadow-inner">
                            <h2 className="text-center font-bold text-xl mb-10">{paperTitle}</h2>
                            {['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'].map(sec => (
                                <div key={sec} className="mb-6">
                                    <h3 className="font-bold underline mb-2">{sec}</h3>
                                    {allData[sec]?.map(b => b.refinedContent && <p key={b.id} className="text-sm mb-4 leading-relaxed text-justify">{b.refinedContent}</p>)}
                                </div>
                            ))}
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
