<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
            authDomain: "cholar-bubbles.firebaseapp.com",
            projectId: "cholar-bubbles",
            storageBucket: "cholar-bubbles.firebasestorage.app",
            messagingSenderId: "965320932006",
            appId: "1:965320932006:web:eeeefce099c0422d4e9267",
            measurementId: "G-Q08F6MFNCD"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            window.fbFunctions = {
                signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
                signInAnonymously, doc, setDoc, updateDoc, deleteDoc, arrayUnion, 
                serverTimestamp, getDoc, collection, addDoc, onSnapshot, query, orderBy
            };
            window.firebaseInitialized = true;
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) { .chat-container { height: calc(100vh - 200px); } }
        .preserve-lines { white-space: pre-wrap; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        const GEMINI_API_KEY = "AIzaSyBxkiHrRf8mImoOVVtvbOfw-DIRA2i8vR0";

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            });
            return <i data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className}></i>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text.replace(/\*\*/g, '').replace(/###/g, '').replace(/#/g, '').replace(/json/g, '').replace(/```/g, '').trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': { label: '×‘×™×ª ×¡×¤×¨ ×™×¡×•×“×™ (×“\'-×•\')', prompt: '×ª×›×ª×•×‘ ×‘×¨××” ×©×œ ×ª×œ××™×“ ×‘×›×™×ª×” ×•\' ×©××’×™×© ×¢×‘×•×“×” ×‘×¨××” ×’×‘×•×”×” ×œ××•×¨×”.' },
            'middle-school': { label: '×—×˜×™×‘×ª ×‘×™× ×™×™×', prompt: '×ª×›×ª×•×‘ ×‘×¨××ª ×ª×œ××™×“ ×‘×’×™×œ 16 ×©×›×•×ª×‘ ×¢×‘×•×“×” ×œ×”×’×©×”.' },
            'high-school': { label: '×ª×™×›×•×Ÿ', prompt: '×ª×›×ª×•×‘ ×‘×¨××” ×©×œ ×¢×‘×•×“×” ×©××•×’×©×ª ×¢×œ ×™×“×™ ×ª×œ××™×“×™× ×‘×’×™×œ 18.' },
            'academic': { label: '××§×“××™', prompt: '×›×ª×•×‘ ×‘×©×¤×” ××§×“××™×ª ××œ××” ×•×’×‘×•×”×”.' }
        };

        const INITIAL_DATA = {
            '×ª×§×¦×™×¨': [
                { id: 'abs-1', title: '××˜×¨×ª ×”××—×§×¨ ×•×”×¨×§×¢', rawInput: '', refinedContent: '' },
                { id: 'abs-2', title: '×©××œ×ª ×”××—×§×¨ ×”××¨×›×–×™×ª', rawInput: '', refinedContent: '' },
                { id: 'abs-3', title: '××ª×•×“×•×œ×•×’×™×” ×‘×§×¦×¨×”', rawInput: '', refinedContent: '' },
                { id: 'abs-4', title: '×××¦××™× ×•×ª×¨×•××ª ×”××—×§×¨', rawInput: '', refinedContent: '' }
            ],
            '××‘×•×': [
                { id: 'intro-1', title: '×”×¦×’×ª ×”× ×•×©× ×•×”×§×©×¨ ×¨×—×‘', rawInput: '', refinedContent: '' },
                { id: 'intro-2', title: '×¡×§×™×¨×” ×”×™×¡×˜×•×¨×™×ª/×—×‘×¨×ª×™×ª ×§×¦×¨×”', rawInput: '', refinedContent: '' },
                { id: 'intro-3', title: '×—×©×™×‘×•×ª ×”××—×§×¨ ×‘×¢×ª ×”× ×•×›×—×™×ª', rawInput: '', refinedContent: '' },
                { id: 'intro-4', title: '×©××œ×ª ×”××—×§×¨ ×•×”×©×¢×¨×•×ª', rawInput: '', refinedContent: '' }
            ],
            '×’×•×£ ×”×¢×‘×•×“×”': [
                { id: 'body-1', title: '×¡×§×™×¨×” ×ª×™××•×¨×˜×™×ª ×•×¡×¤×¨×•×ª×™×ª', rawInput: '', refinedContent: '' },
                { id: 'body-2', title: '×˜×™×¢×•×Ÿ ××¨×›×–×™ ×¨××©×•×Ÿ - ×‘×™×¡×•×¡', rawInput: '', refinedContent: '' },
                { id: 'body-3', title: '× ×™×ª×•×— ××§×¨×” ××• ×“×•×’××” ××³', rawInput: '', refinedContent: '' },
                { id: 'body-4', title: '×˜×™×¢×•×Ÿ ××¨×›×–×™ ×©× ×™ - ×”×¨×—×‘×”', rawInput: '', refinedContent: '' },
                { id: 'body-5', title: '× ×™×ª×•×— ××§×¨×” ××• ×“×•×’××” ×‘×³', rawInput: '', refinedContent: '' },
                { id: 'body-6', title: '×“×™×•×Ÿ ×‘×™×§×•×¨×ª×™ ×•× ×§×•×“×•×ª ××‘×˜ ×©×•× ×•×ª', rawInput: '', refinedContent: '' },
                { id: 'body-7', title: '××™× ×˜×’×¨×¦×™×” ×©×œ ×”×˜×™×¢×•× ×™×', rawInput: '', refinedContent: '' }
            ],
            '×××¦××™×': [
                { id: 'res-1', title: '×ª×™××•×¨ ×”×××¦××™× ×”×¢×™×§×¨×™×™×', rawInput: '', refinedContent: '' },
                { id: 'res-2', title: '× ×™×ª×•×— × ×ª×•× ×™× (×›××•×ª×™/××™×›×•×ª× ×™)', rawInput: '', refinedContent: '' },
                { id: 'res-3', title: '×”×©×•×•××” ×‘×™×Ÿ ×”×©×¢×¨×•×ª ×œ××¦×™××•×ª', rawInput: '', refinedContent: '' },
                { id: 'res-4', title: '××©××¢×•×ª ×”×××¦××™×', rawInput: '', refinedContent: '' }
            ],
            '×¡×™×›×•×': [
                { id: 'conc-1', title: '×ª××¦×™×ª ×”××¡×§× ×•×ª', rawInput: '', refinedContent: '' },
                { id: 'conc-2', title: '××¢× ×” ×¡×•×¤×™ ×œ×©××œ×ª ×”××—×§×¨', rawInput: '', refinedContent: '' },
                { id: 'conc-3', title: '××’×‘×œ×•×ª ×”××—×§×¨', rawInput: '', refinedContent: '' },
                { id: 'conc-4', title: '×”××œ×¦×•×ª ×œ××—×§×¨ ×¢×ª×™×“×™', rawInput: '', refinedContent: '' }
            ],
            '×‘×™×‘×œ×™×•×’×¨×¤×™×”': []
        };

        const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false, user, trackAction }) => {
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || loading) return;
                const userMsg = { role: 'user', text: input };
                const currentInput = input;
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setLoading(true);
                if(trackAction) trackAction(withSearchTool ? "search_query" : "research_chat", { query: currentInput });

                try {
                    const payload = {
                        contents: [...messages, userMsg].map(m => ({ 
                            role: m.role === 'ai' ? 'model' : 'user', 
                            parts: [{ text: m.text }] 
                        })),
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    
                    if (withSearchTool) {
                        payload.tools = [{ googleSearch: {} }];
                    }
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }
                    );
                    
                    if (!response.ok) throw new Error("API Error: " + response.status);
                    
                    const data = await response.json();
                    let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "××¦×˜×¢×¨, ×œ× ×”×¦×œ×—×ª×™ ×œ×¢×‘×“ ××ª ×”×‘×§×©×”.";
                    
                    const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions;
                    if (grounding) {
                        aiText += "\n\nğŸ“š ××§×•×¨×•×ª:\n";
                        grounding.forEach(g => {
                            if (g.web?.uri && g.web?.title) {
                                aiText += `â€¢ [${g.web.title}](${g.web.uri})\n`;
                            }
                        });
                    }

                    setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(aiText) }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'ai', text: "âŒ ×©×’×™××”: " + e.message }]);
                }
                setLoading(false);
            };

            return (
                <div className="chat-container bg-white rounded-2xl border overflow-hidden shadow-sm h-full flex flex-col">
                    <div className="p-4 border-b bg-slate-50">
                        <h2 className="text-xl font-black text-indigo-600 flex items-center gap-2">{title}</h2>
                        <p className="text-xs text-slate-500">{subTitle}</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-white" ref={scrollRef}>
                        {messages.length === 0 && <div className="text-center text-slate-400 py-10">×”×ª×—×œ ×©×™×—×”...</div>}
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-slate-100 text-slate-800' : 'bg-indigo-50 text-indigo-900 border border-indigo-100'}`}>
                                    {m.text.split('\n').map((line, idx) => {
                                        const parts = line.split(/(\[(?:.*?)\]\((?:.*?)\)|https?:\/\/[^\s]+)/g);
                                        return <div key={idx}>{parts.map((part, pIdx) => {
                                            const mdLink = part.match(/\[(.*?)\]\((.*?)\)/);
                                            if (mdLink) return <a key={pIdx} href={mdLink[2]} target="_blank" className="text-blue-600 underline font-bold">{mdLink[1]}</a>;
                                            if (part.match(/^https?:\/\//)) return <a key={pIdx} href={part} target="_blank" className="text-blue-600 underline break-all">{part}</a>;
                                            return <span key={pIdx}>{part}</span>;
                                        })}</div>;
                                    })}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 animate-pulse">××§×œ×™×“...</div>}
                    </div>
                    <div className="p-3 bg-white border-t flex gap-2">
                        <input 
                            className="flex-1 px-4 py-2 border rounded-full text-sm outline-none" 
                            placeholder="×›×ª×•×‘ ×›××Ÿ..." 
                            value={input} 
                            onChange={e => setInput(e.target.value)} 
                            onKeyPress={e => e.key === 'Enter' && sendMessage()} 
                        />
                        <button onClick={sendMessage} className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center">
                            <Icon name="send" size={16} />
                        </button>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const { signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, doc, setDoc, serverTimestamp } = window.fbFunctions;
            const auth = window.fbAuth;
            const db = window.fbDb;

            const saveUserToDB = async (user) => {
                try {
                    const userRef = doc(db, 'users', user.uid);
                    await setDoc(userRef, { 
                        email: user.email, 
                        displayName: user.displayName || '××©×ª××©', 
                        lastLogin: serverTimestamp(), 
                        uid: user.uid 
                    }, { merge: true });
                } catch (e) { 
                    console.error("Error saving user to DB:", e); 
                }
            };

            const handleGoogleSignIn = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { 
                    console.error(err); 
                    setError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ'); 
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let result;
                    if (isRegistering) result = await createUserWithEmailAndPassword(auth, email, password);
                    else result = await signInWithEmailAndPassword(auth, email, password);
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { 
                    console.error(err); 
                    setError(isRegistering ? '×©×’×™××” ×‘×”×¨×©××”' : '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×'); 
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-white p-8 rounded-3xl text-center max-w-md w-full">
                        <h2 className="text-2xl font-black mb-4">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
                        <button onClick={handleGoogleSignIn} className="w-full border p-3 rounded-xl mb-4 font-bold flex justify-center gap-2">
                            ×”××©×š ×¢× Google
                        </button>
                        <form onSubmit={handleEmailAuth} className="space-y-3">
                            <input 
                                type="email" 
                                placeholder="××™××™×™×œ" 
                                value={email} 
                                onChange={e=>setEmail(e.target.value)} 
                                className="w-full p-3 border rounded-xl" 
                                required 
                            />
                            <input 
                                type="password" 
                                placeholder="×¡×™×¡××”" 
                                value={password} 
                                onChange={e=>setPassword(e.target.value)} 
                                className="w-full p-3 border rounded-xl" 
                                required 
                            />
                            {error && <p className="text-red-500 text-xs">{error}</p>}
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold"
                            >
                                {loading ? '...' : (isRegistering ? '×”×¨×©××”' : '×›× ×™×¡×”')}
                            </button>
                        </form>
                        <button 
                            onClick={() => setIsRegistering(!isRegistering)} 
                            className="mt-4 text-xs text-indigo-500 underline"
                        >
                            {isRegistering ? '×™×© ×œ×š ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨' : '××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©×'}
                        </button>
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ user, onSelect, onLogout }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-right">
                <div className="bg-white p-8 rounded-3xl w-full max-w-4xl flex flex-col md:flex-row h-[80vh]">
                    <div className="md:w-1/2 bg-indigo-600 text-white p-8 flex flex-col justify-center items-center text-center rounded-2xl">
                        <Icon name="book-open" size={48} className="mb-4" />
                        <h1 className="text-3xl font-black">ScholarBubbles</h1>
                        <p>Toledano EdTech</p>
                        <div className="mt-4 text-xs bg-white/20 px-3 py-1 rounded-full">{user.email}</div>
                    </div>
                    <div className="md:w-1/2 p-8 overflow-y-auto">
                        <h2 className="text-xl font-bold mb-6">×‘×—×¨/×™ ×¨××ª ×›×ª×™×‘×”:</h2>
                        <div className="space-y-3">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button 
                                    key={key} 
                                    onClick={() => onSelect(key)} 
                                    className="w-full text-right p-4 border rounded-xl hover:bg-indigo-50 flex justify-between"
                                >
                                    <span className="font-bold">{info.label}</span>
                                    <Icon name="chevron-left" />
                                </button>
                            ))}
                        </div>
                        <button 
                            onClick={onLogout} 
                            className="mt-8 text-sm text-red-500 flex items-center gap-2"
                        >
                            <Icon name="log-out" size={16} /> ×”×ª× ×ª×§
                        </button>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('××‘×•×');
            const [paperTitle, setPaperTitle] = useState('×›×•×ª×¨×ª ×”×¢×‘×•×“×” ×©×œ×š');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projectsList, setProjectsList] = useState([]);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [saveStatus, setSaveStatus] = useState('saved');
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [showMobilePreview, setShowMobilePreview] = useState(false);
            const sections = ['×ª×§×¦×™×¨', '××‘×•×', '×’×•×£ ×”×¢×‘×•×“×”', '×××¦××™×', '×¡×™×›×•×', '×‘×™×‘×œ×™×•×’×¨×¤×™×”'];

            useEffect(() => {
                const timer = setTimeout(() => setLoadingAuth(false), 3000);
                const checkFirebase = () => {
                    if (window.fbFunctions) {
                        window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                            setUser(u);
                            setLoadingAuth(false);
                            if (u) loadProjectsList(u.uid);
                        });
                    } else {
                        window.addEventListener('firebase-ready', () => {
                            window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                                setUser(u);
                                setLoadingAuth(false);
                                if (u) loadProjectsList(u.uid);
                            });
                        });
                    }
                };
                checkFirebase();
                return () => clearTimeout(timer);
            }, []);

            const loadProjectsList = (uid) => {
                const q = window.fbFunctions.query(
                    window.fbFunctions.collection(window.fbDb, "users", uid, "projects"),
                    window.fbFunctions.orderBy("lastUpdated", "desc")
                );
                window.fbFunctions.onSnapshot(q, (snapshot) => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjectsList(projects);
                    if (projects.length > 0 && !currentProjectId) loadProject(projects[0]);
                });
            };

            const loadProject = (project) => {
                setCurrentProjectId(project.id);
                setPaperTitle(project.paperTitle);
                setAllData(project.allData || INITIAL_DATA);
                if (project.level) setLevel(project.level);
            };

            const deleteProject = async (e, projectId) => {
                e.stopPropagation();
                if (!confirm("×œ××—×•×§?")) return;
                try {
                    await window.fbFunctions.deleteDoc(
                        window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", projectId)
                    );
                    if (projectId === currentProjectId) createNewProject();
                } catch (err) { 
                    alert("×©×’×™××” ×‘××—×™×§×”"); 
                }
            };

            const createNewProject = () => {
                setCurrentProjectId(null);
                setPaperTitle('×¢×‘×•×“×” ×—×“×©×”');
                setAllData(INITIAL_DATA);
                setLevel(null);
            };

            useEffect(() => {
                if (!user || !level) return;
                const timeoutId = setTimeout(() => saveUserData(), 2000);
                return () => clearTimeout(timeoutId);
            }, [allData, paperTitle, level]);

            const saveUserData = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    const projectData = { 
                        paperTitle, 
                        allData, 
                        level, 
                        lastUpdated: window.fbFunctions.serverTimestamp() 
                    };
                    if (currentProjectId) {
                        await window.fbFunctions.updateDoc(
                            window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", currentProjectId),
                            projectData
                        );
                    } else {
                        const docRef = await window.fbFunctions.addDoc(
                            window.fbFunctions.collection(window.fbDb, "users", user.uid, "projects"),
                            projectData
                        );
                        setCurrentProjectId(docRef.id);
                    }
                    setSaveStatus('saved');
                } catch (e) { 
                    setSaveStatus('error'); 
                }
            };

            const trackAction = async (actionType, details = {}) => {
                if (!user || !window.fbDb) return;
                try { 
                    await window.fbFunctions.addDoc(
                        window.fbFunctions.collection(window.fbDb, 'users', user.uid, 'activity_log'),
                        { 
                            action: actionType, 
                            ...details, 
                            timestamp: window.fbFunctions.serverTimestamp() 
                        }
                    ); 
                } catch (e) {}
            };

            const handleUpdate = (id, updates) => {
                setAllData(prev => ({ 
                    ...prev, 
                    [view]: prev[view].map(b => b.id === id ? {...b, ...updates} : b) 
                }));
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                handleUpdate(id, { isRefining: true });
                trackAction("refine_attempt", { section: view });

                const isBib = view === '×‘×™×‘×œ×™×•×’×¨×¤×™×”';
                let promptText = isBib
                    ? `×¢×¦×‘ ×›×¦×™×˜×•×˜ ×‘×™×‘×œ×™×•×’×¨×¤×™ ×ª×§× ×™: "${bubble.rawInput}". ×”×—×–×¨ ×¨×§ ××ª ×”×¦×™×˜×•×˜.`
                    : `×”× ×•×©×: ${paperTitle}. ×¤×¨×§: ${view}. ×¨××”: ${WRITING_LEVELS[level].prompt}.
                    ×ª×•×›×Ÿ ×§×•×“×: ${allData[view].filter(b => b.id !== id && b.refinedContent).map(b => b.refinedContent).join("\n")}
                    ×ª×•×›×Ÿ ×œ×‘×•×¢×” ×–×•: "${bubble.rawInput}".
                    ××©×™××”: ×›×ª×•×‘ ×¤×¡×§×” ××œ××” ×•×¢×©×™×¨×” (200+ ××™×œ×™×), ×¢× ×—×œ×•×§×” ×œ×¤×¡×§××•×ª ××©× ×” (×©×•×¨×ª ×¨×•×•×—). ×‘×œ×™ ×›×•×ª×¨×•×ª/×¤×ª×™×—×™×/×¡×™×•××•×ª.`;

                try {
                    if(!GEMINI_API_KEY) throw new Error("No API Key");
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: promptText }] }] 
                            })
                        }
                    );
                    const resJson = await response.json();
                    const text = resJson.candidates?.[0]?.content?.parts?.[0]?.text || "×©×’×™××”";
                    handleUpdate(id, { refinedContent: cleanMarkdown(text), isRefining: false });
