<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <!-- סמליל (Favicon) -->
    <link rel="icon" href="https://img.icons8.com/color/48/000000/open-book--v1.png" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) {
            .chat-container { height: calc(100vh - 200px); }
        }
        .preserve-lines { white-space: pre-wrap; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, serverTimestamp, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const { useState, useEffect, useRef, useCallback } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- הגדרות ---
        
        const firebaseConfig = {
  apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
  authDomain: "cholar-bubbles.firebaseapp.com",
  projectId: "cholar-bubbles",
  storageBucket: "cholar-bubbles.firebasestorage.app",
  messagingSenderId: "965320932006",
  appId: "1:965320932006:web:eeeefce099c0422d4e9267",
  measurementId: "G-Q08F6MFNCD"
};
        
        const apiKey = "AIzaSyB5Ah95TlVKK6CWyTnwCPd1Dv8ND5xKdBk"; 
        // אתחול Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // חשיפה לשימוש ב-Component
        window.fbFunctions = {
            signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
            doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, 
            collection, addDoc, onSnapshot, query, orderBy
        };
        window.fbAuth = auth;
        window.fbDb = db;

        // --- רכיבים ---

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className}></i>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text
                .replace(/\*\*/g, '')
                .replace(/###/g, '')
                .replace(/#/g, '')
                .replace(/^שלום!|^בהחלט!|^הנה הפסקה המלוטשת:|^להלן התוכן:|^לסיכום,/g, '')
                .replace(/json/g, '')
                .replace(/```/g, '')
                .trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': {
                label: 'בית ספר יסודי (ד\'-ו\')',
                prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה.'
            },
            'middle-school': { 
                label: 'חטיבת ביניים', 
                prompt: 'כתוב בשפה תקנית, מכובדת ורצינית המתאימה לעבודת הגשה בחטיבת ביניים. הימנע מסלנג או שפה מדוברת ("דיבור רחוב"), אך שמור על בהירות.' 
            },
            'high-school': { 
                label: 'תיכון', 
                prompt: 'תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18. השתמש בשפה עשירה, מבנה לוגי מורכב וניסוחים ברמה גבוהה.' 
            },
            'academic': { 
                label: 'אקדמי', 
                prompt: 'כתוב בשפה אקדמית גבוהה, אובייקטיבית ומעמיקה. נתח כל נקודה בהרחבה רבה תוך שימוש בטרמינולוגיה מקצועית.' 
            }
        };

        const INITIAL_DATA = {
            'תקציר': [
                { id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' },
                { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' },
                { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' },
                { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' },
                { id: 'abs-sum', title: 'פסקה מסכמת לתקציר', rawInput: '', refinedContent: '' }
            ],
            'מבוא': [
                { id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' },
                { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' },
                { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' },
                { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' },
                { id: 'intro-sum', title: 'לסיכום המבוא ומבנה העבודה', rawInput: '', refinedContent: '' }
            ],
            'גוף העבודה': [
                { id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' },
                { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' },
                { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' },
                { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' },
                { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' },
                { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' },
                { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' },
                { id: 'body-sum', title: 'לסיכום פרק גוף העבודה', rawInput: '', refinedContent: '' }
            ],
            'ממצאים': [
                { id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' },
                { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' },
                { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' },
                { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' },
                { id: 'res-sum', title: 'לסיכום פרק הממצאים', rawInput: '', refinedContent: '' }
            ],
            'סיכום': [
                { id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' },
                { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' },
                { id: 'conc-sum', title: 'דברי סיום', rawInput: '', refinedContent: '' }
            ],
            'ביבליוגרפיה': []
        };

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const { signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, doc, setDoc, serverTimestamp, collection, addDoc } = window.fbFunctions;
            const auth = window.fbAuth;
            const db = window.fbDb;

            const handleGoogleSignIn = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) { 
                    console.error(err);
                    setError('שגיאה בהתחברות עם גוגל'); 
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) { 
                    console.error(err);
                    setError(isRegistering ? 'שגיאה בהרשמה' : 'שם משתמש או סיסמה שגויים'); 
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4 overflow-y-auto">
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-full h-2 bg-indigo-600"></div>
                        <div className="mb-6 flex justify-center"><Icon name="shield-check" size={48} className="text-indigo-600" /></div>
                        <h2 className="text-2xl font-black mb-2 tracking-tight">כלי עזר מתקדם לכתיבת עבודות ומאמרים</h2>
                        <p className="text-slate-500 mb-8 text-sm font-medium">מבית <span className="text-indigo-600 font-bold">Toledano-edtech</span></p>
                        
                        <button onClick={handleGoogleSignIn} className="w-full flex items-center justify-center gap-3 border-2 border-slate-100 p-3 rounded-xl hover:bg-slate-50 transition-all mb-6">
                            <span className="font-bold">המשך עם Google</span>
                        </button>

                        <div className="relative mb-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-100"></div></div>
                            <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">או הזדהות רגילה</span></div>
                        </div>

                        <form onSubmit={handleEmailAuth} className="space-y-4 text-right">
                            <div>
                                <label className="text-xs font-bold mr-1 block mb-1 text-slate-600">אימייל</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl outline-none focus:ring-2 ring-indigo-100 transition-all" required />
                            </div>
                            <div>
                                <label className="text-xs font-bold mr-1 block mb-1 text-slate-600">סיסמה</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl outline-none focus:ring-2 ring-indigo-100 transition-all" required />
                            </div>
                            {error && <p className="text-red-500 text-xs mt-2 bg-red-50 p-2 rounded">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700 mt-4 transition-colors shadow-lg shadow-indigo-100">
                                {loading ? 'טוען...' : (isRegistering ? 'הרשמה' : 'כניסה')}
                            </button>
                        </form>
                        
                        <button onClick={() => setIsRegistering(!isRegistering)} className="mt-4 text-xs text-indigo-500 hover:underline">
                            {isRegistering ? 'יש לך כבר חשבון? התחבר' : 'אין לך חשבון? הירשם כאן'}
                        </button>
                    </motion.div>
                </div>
            );
        };

        const WelcomeScreen = ({ user, onSelect, onLogout }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-right">
                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="max-w-4xl w-full bg-white rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] md:max-h-none overflow-y-auto">
                    <div className="md:w-1/2 bg-indigo-600 p-8 md:p-12 text-white flex flex-col justify-center items-center md:items-start text-center md:text-right relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-600 to-indigo-800 opacity-50"></div>
                        <div className="relative z-10">
                            <div className="mb-4 md:mb-6">
                                <Icon name="book-open" size={48} className="text-indigo-200" />
                            </div>
                            <h1 className="text-3xl md:text-4xl font-black mb-2 md:mb-4">ScholarBubbles</h1>
                            <p className="text-indigo-100 text-base md:text-lg font-medium leading-relaxed mb-4">
                                כלי עזר מתקדם לכתיבת עבודות ומאמרים<br/>
                                <span className="text-white opacity-80 text-sm">מבית Toledano-edtech</span>
                            </p>
                            <div className="mt-4 inline-flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full text-xs backdrop-blur-sm border border-white/20">
                                <Icon name="user" size={14} /> שלום, {user.displayName || user.email}
                            </div>
                        </div>
                    </div>
                    <div className="md:w-1/2 p-6 md:p-12 bg-white flex flex-col justify-center">
                        <h2 className="text-lg md:text-xl font-bold mb-6 md:mb-8 text-slate-800 text-center md:text-right">בחר/י את רמת הכתיבה:</h2>
                        <div className="space-y-3 md:space-y-4">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button key={key} onClick={() => onSelect(key)} className="w-full text-right p-4 md:p-5 rounded-xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition-all group flex items-center justify-between">
                                    <span className="font-bold text-sm md:text-base text-slate-900">{info.label}</span>
                                    <div className="text-slate-300 group-hover:text-indigo-500">
                                        <Icon name="chevron-left" size={20} />
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={onLogout} className="mt-8 mx-auto md:mx-0 flex items-center gap-2 text-sm text-slate-400 hover:text-red-500 transition-colors">
                            <Icon name="log-out" size={16} /> התנתק
                        </button>
                    </div>
                </motion.div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projectsList, setProjectsList] = useState([]);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [saveStatus, setSaveStatus] = useState('saved'); 
            
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [showMobilePreview, setShowMobilePreview] = useState(false);

            const sections = ['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'];

            useEffect(() => {
                const unsubscribe = window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                    setUser(u);
                    setLoadingAuth(false);
                    if (u) {
                        loadProjectsList(u.uid);
                    }
                });
                return () => unsubscribe();
            }, []);

            // טעינת רשימת פרויקטים
            const loadProjectsList = (uid) => {
                const q = window.fbFunctions.query(
                    window.fbFunctions.collection(window.fbDb, "users", uid, "projects"),
                    window.fbFunctions.orderBy("lastUpdated", "desc")
                );
                
                window.fbFunctions.onSnapshot(q, (snapshot) => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjectsList(projects);
                    // אם יש פרויקטים, טען את האחרון, אחרת צור חדש
                    if (projects.length > 0 && !currentProjectId) {
                        loadProject(projects[0]);
                    }
                });
            };

            const loadProject = (project) => {
                setCurrentProjectId(project.id);
                setPaperTitle(project.paperTitle);
                setAllData(project.allData);
                if (project.level) setLevel(project.level);
            };

            const createNewProject = () => {
                setCurrentProjectId(null);
                setPaperTitle('עבודה חדשה');
                setAllData(INITIAL_DATA);
                setLevel(null); // חוזר לבחירת רמה
            };

            // שמירה אוטומטית
            useEffect(() => {
                if (!user || !level) return; // לא לשמור אם עדיין לא נבחרה רמה
                const timeoutId = setTimeout(() => saveUserData(), 2000);
                return () => clearTimeout(timeoutId);
            }, [allData, paperTitle, level]);

            const saveUserData = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    const projectData = {
                        paperTitle,
                        allData,
                        level,
                        lastUpdated: window.fbFunctions.serverTimestamp()
                    };

                    if (currentProjectId) {
                        await window.fbFunctions.updateDoc(
                            window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", currentProjectId),
                            projectData
                        );
                    } else {
                        const docRef = await window.fbFunctions.addDoc(
                            window.fbFunctions.collection(window.fbDb, "users", user.uid, "projects"),
                            projectData
                        );
                        setCurrentProjectId(docRef.id);
                    }
                    setSaveStatus('saved');
                } catch (e) {
                    console.error("Save Error:", e);
                    setSaveStatus('error');
                }
            };

            const handleLevelSelect = (l) => {
                setLevel(l);
            };

            const handleUpdate = (id, updates) => {
                setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, ...updates} : b) }));
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                const isBibliography = view === 'ביבליוגרפיה';
                handleUpdate(id, { isRefining: true });

                let promptText = '';
                let taskDescription = '';

                if (isBibliography) {
                    promptText = `המטרה: יצירת פריט ביבליוגרפי תקני ומדויק.
                    קח את המידע הגולמי: "${bubble.rawInput}".
                    עצב אותו לפי "כללי הציטוט האחיד" (הנהוגים במשפט ובמדעי הרוח בישראל) או APA.
                    החזר רק את השורה הביבליוגרפית המעוצבת, ללא טקסט נוסף.`;
                } else {
                    if (level === 'elementary-school') {
                        taskDescription = 'חשוב ביותר: תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה. הכתיבה צריכה להיות ברורה, מכובדת ומותאמת לגיל.';
                    } else if (level === 'middle-school') {
                        taskDescription = 'חשוב ביותר: כתוב ברמת תלמיד בגיל 16 שכותב עבודה להגשה. הכתיבה צריכה להיות טבעית, זורמת ומכובדת, שפה תקנית אך לא "אקדמית" מידי.';
                    } else if (level === 'high-school') {
                        taskDescription = 'חשוב ביותר: תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18 (עבודת גמר בתיכון). רמה גבוהה, תקנית ועשירה.';
                    } else {
                        taskDescription = 'כתוב ברמה אקדמית מלאה וגבוהה.';
                    }

                    const previousContent = allData[view]
                        .slice(0, allData[view].findIndex(b => b.id === id))
                        .map(b => b.refinedContent)
                        .filter(Boolean)
                        .join("\n\n");

                    promptText = `הנושא: ${paperTitle}. הפרק: ${view}.
                    
                    הנחיית רמה: ${WRITING_LEVELS[level].prompt}
                    
                    טקסט קודם רציף בפרק זה (להמשכיות):
                    ${previousContent || "זוהי תחילת הפרק"}

                    מידע גולמי לבועה זו:
                    "${bubble.rawInput}"
                    
                    משימה:
                    כתוב פסקה מורחבת (לפחות 150-200 מילים) המבוססת על המידע הגולמי.
                    ${taskDescription}
                    
                    הנחיות נוספות:
                    1. הרחב את הנקודות לטקסט מלא ועשיר.
                    2. כתוב כהמשך ישיר לטקסט הקודם. בלי פתיחות כמו "בפסקה זו" ובלי סיומות כמו "לסיכום".
                    3. חשוב מאוד: חלק את הטקסט לפסקאות פנימיות נפרדות בעזרת שורה רווח. אל תכתוב גוש טקסט אחד ארוך.
                    4. אל תשתמש בכוכביות.
                    5. אל תכתוב שום מילות פתיחה (כמו 'הנה', 'להלן', 'תשובה'). התחל ישר במשפט הראשון של הפסקה.`;
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }] }]
                        })
                    });
                    const resJson = await response.json();
                    const text = resJson.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    handleUpdate(id, { refinedContent: cleanMarkdown(text), isRefining: false });
                } catch (e) { handleUpdate(id, { isRefining: false }); }
            };

            const downloadAsWord = () => {
                const styles = `
                    <style>
                        @page { size: A4; margin: 2.54cm; }
                        body { 
                            direction: rtl; 
                            text-align: right; 
                            font-family: 'David', 'Times New Roman', serif; 
                            font-size: 12pt; 
                            line-height: 150%; 
                            mso-line-height-rule: exactly;
                        }
                        h1 { font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 24pt; }
                        h2 { font-size: 14pt; font-weight: bold; margin-top: 18pt; margin-bottom: 12pt; border-bottom: 1px solid #000; }
                        p { margin-bottom: 12pt; text-align: right; line-height: 150%; }
                    </style>
                `;
                let content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${paperTitle}</title>${styles}</head><body>`;
                
                content += `<h1>${paperTitle}</h1>`;
                sections.forEach(sec => {
                    const bubbles = allData[sec];
                    if (bubbles?.some(b => b.refinedContent)) {
                        content += `<h2>${sec}</h2>`;
                        bubbles.forEach(b => {
                            if (b.refinedContent) {
                                const style = sec === 'ביבליוגרפיה' ? "padding-right: 1cm; text-indent: -1cm;" : "";
                                content += `<p style="${style}">${b.refinedContent.replace(/\n/g, '<br>')}</p>`;
                            }
                        });
                    }
                });
                content += `</body></html>`;
                
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${paperTitle}.doc`;
                link.click();
            };

            const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false }) => {
                const [input, setInput] = useState('');
                const [loading, setLoading] = useState(false);
                const scrollRef = useRef(null);

                useEffect(() => {
                    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }, [messages]);

                const sendMessage = async () => {
                    if (!input.trim() || loading) return;
                    const userMsg = { role: 'user', text: input };
                    setMessages(prev => [...prev, userMsg]);
                    setInput('');
                    setLoading(true);

                    try {
                        const payload = {
                            contents: [...messages, userMsg].map(m => ({ role: m.role === 'ai' ? 'model' : 'user', parts: [{ text: m.text }] })),
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        };
                        if (withSearchTool) {
                            payload.tools = [{ google_search: {} }];
                        }

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "מצטער, לא הצלחתי לעבד את הבקשה.";
                        
                        const grounding = data.candidates?.[0]?.groundingMetadata?.groundingAttributions;
                        if (grounding) {
                            aiText += "\n\nמקורות שמצאתי:\n";
                            grounding.forEach(g => {
                                if (g.web?.uri && g.web?.title) {
                                    aiText += `• [${g.web.title}](${g.web.uri})\n`;
                                }
                            });
                        }

                        setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(aiText) }]);
                    } catch (e) {
                        setMessages(prev => [...prev, { role: 'ai', text: "שגיאה בתקשורת עם השרת." }]);
                    }
                    setLoading(false);
                };

                return (
                    <div className="chat-container bg-white rounded-2xl border overflow-hidden shadow-sm h-full flex flex-col">
                        <div className="p-4 border-b bg-slate-50">
                            <h2 className="text-lg md:text-xl font-black text-indigo-600 flex items-center gap-2">{title}</h2>
                            <p className="text-xs text-slate-500">{subTitle}</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-white" ref={scrollRef}>
                            {messages.length === 0 && <div className="text-center text-slate-400 py-10">התחל שיחה...</div>}
                            {messages.map((m, i) => (
                                <div key={i} className={`flex mb-4 ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                    <div className={`p-3 rounded-2xl max-w-[85%] text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-slate-100 text-slate-800' : 'bg-indigo-50 text-indigo-900 border border-indigo-100'}`}>
                                        {m.text.split('\n').map((line, idx) => {
                                            const parts = line.split(/(\[(?:.*?)\]\((?:.*?)\)|https?:\/\/[^\s]+)/g);
                                            return (
                                                <div key={idx} className="flex flex-wrap gap-1">
                                                    {parts.map((part, pIdx) => {
                                                        const mdLink = part.match(/\[(.*?)\]\((.*?)\)/);
                                                        if (mdLink) {
                                                            return <a key={pIdx} href={mdLink[2]} target="_blank" rel="noopener noreferrer" className="text-blue-600 underline font-bold">{mdLink[1]}</a>;
                                                        }
                                                        if (part.match(/^https?:\/\//)) {
                                                            return <a key={pIdx} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-600 underline break-all">{part}</a>;
                                                        }
                                                        return <span key={pIdx}>{part}</span>;
                                                    })}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                            {loading && <div className="text-xs text-slate-400 animate-pulse mr-4">ה-AI מקליד...</div>}
                        </div>
                        <div className="p-3 bg-white border-t flex gap-2">
                            <input 
                                className="flex-1 px-4 py-2 bg-slate-50 border rounded-full text-sm outline-none focus:ring-2 ring-indigo-100" 
                                placeholder="כתוב כאן..." 
                                value={input} 
                                onChange={e => setInput(e.target.value)} 
                                onKeyPress={e => e.key === 'Enter' && sendMessage()} 
                            />
                            <button onClick={sendMessage} className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center hover:bg-indigo-700 disabled:opacity-50" disabled={loading}>
                                <Icon name="send" size={16} />
                            </button>
                        </div>
                    </div>
                );
            };

            if (loadingAuth) return <div className="flex h-screen items-center justify-center text-indigo-600"><Icon name="loader-2" className="animate-spin" size={48}/></div>;
            if (!user) return <AuthScreen onAuthSuccess={setUser} />;
            if (!level) return <WelcomeScreen user={user} onSelect={handleLevelSelect} onLogout={() => window.fbFunctions.signOut(window.fbAuth)} />;

            return (
                <div className="flex h-[100dvh] overflow-hidden bg-white flex-col md:flex-row font-sans" dir="rtl">
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 right-0 z-40 w-64 bg-slate-900 text-white p-6 transform transition-transform duration-300 ease-in-out ${mobileMenuOpen ? 'translate-x-0' : 'translate-x-full'} md:relative md:translate-x-0 md:block md:shadow-xl`}>
                        <div className="hidden md:block mb-6 cursor-pointer" onClick={() => setLevel(null)}>
                            <h1 className="text-xl font-bold flex items-center gap-3"><Icon name="book-open" className="text-indigo-400" /> ScholarBubbles</h1>
                            <div className="text-[10px] mt-2 bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded inline-block">רמת {WRITING_LEVELS[level].label}</div>
                        </div>

                        {/* רשימת עבודות קודמות */}
                        <div className="mb-6">
                            <h3 className="text-xs font-bold text-slate-500 uppercase mb-2">העבודות שלי</h3>
                            <div className="space-y-1 max-h-32 overflow-y-auto">
                                <button onClick={createNewProject} className="w-full text-right p-2 rounded text-xs text-indigo-300 hover:bg-slate-800 flex items-center gap-2"><Icon name="plus" size={12}/> עבודה חדשה</button>
                                {projectsList.map(p => (
                                    <button key={p.id} onClick={() => loadProject(p)} className={`w-full text-right p-2 rounded text-xs truncate ${currentProjectId === p.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}`}>
                                        {p.paperTitle || 'ללא כותרת'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <nav className="flex-1 space-y-1 overflow-y-auto max-h-[calc(100vh-350px)]">
                            <button onClick={() => {setView('question'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-2 border border-slate-700 flex items-center gap-2 ${view === 'question' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="help-circle" size={14}/> שאלת מחקר AI</button>
                            <button onClick={() => {setView('search'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-6 border border-slate-700 flex items-center gap-2 ${view === 'search' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="search" size={14}/> חיפוש מקורות AI</button>
                            
                            <div className="text-[10px] text-slate-500 font-bold uppercase mb-2 mr-2">כתיבת העבודה</div>
                            {sections.map(s => (
                                <button key={s} onClick={() => {setView(s); setMobileMenuOpen(false);}} className={`w-full text-right flex items-center justify-between p-3 rounded-xl text-sm transition-all ${view === s ? 'bg-indigo-600 font-bold' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>
                                    {s}
                                    {allData[s]?.some(b => b.refinedContent) && <Icon name="check-circle" size={14} className="text-emerald-400" />}
                                </button>
                            ))}
                        </nav>
                        <div className="mt-4 pt-4 border-t border-slate-800">
                             <div className="text-[10px] text-slate-500 mb-1 truncate">{user.email}</div>
                             <div className={`text-[10px] font-bold ${saveStatus==='error'?'text-red-400':'text-emerald-400'}`}>{saveStatus==='saving'?'שומר...':saveStatus==='error'?'שגיאת שמירה':'נשמר'}</div>
                             <button onClick={downloadAsWord} className="w-full mt-4 bg-emerald-600 text-white p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-emerald-700">
                                <Icon name="download" size={14} /> הורד Word
                             </button>
                        </div>
                    </aside>

                    {/* Mobile Header & Overlay */}
                    <div className="md:hidden flex items-center justify-between p-4 bg-slate-900 text-white shadow-md z-50 fixed top-0 w-full">
                         <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><Icon name={mobileMenuOpen ? "x" : "menu"} /></button>
                         <span className="font-bold">ScholarBubbles</span>
                         <button onClick={() => setShowMobilePreview(!showMobilePreview)} className="bg-slate-700 px-3 py-1 rounded-full text-sm">{showMobilePreview ? 'עריכה' : 'תצוגה'}</button>
                    </div>
                    {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setMobileMenuOpen(false)} />}

                    <main className="flex-1 flex overflow-hidden relative pt-16 md:pt-0">
                        <section className={`flex-1 p-4 md:p-8 overflow-y-auto border-l bg-slate-50/30 ${showMobilePreview ? 'hidden md:block' : 'block'}`}>
                            <div className="max-w-3xl mx-auto h-full flex flex-col">
                                <div className="mb-6 p-4 bg-white border border-indigo-100 rounded-2xl shadow-sm">
                                    <label className="text-[10px] uppercase font-bold text-indigo-400 block mb-1">נושא העבודה</label>
                                    <input className="w-full bg-transparent text-lg md:text-xl font-black text-slate-800 outline-none" value={paperTitle} onChange={(e) => setPaperTitle(e.target.value)} />
                                </div>

                                {view === 'question' ? (
                                    <AIChatComponent 
                                        title="גיבוש שאלת מחקר" 
                                        subTitle="אני אעזור לך לחדד ולנסח את שאלת המחקר המדויקת ביותר."
                                        messages={questionChatMessages}
                                        setMessages={setQuestionChatMessages}
                                        systemPrompt={`אתה מנחה אקדמי מנוסה. המטרה שלך: לעזור לסטודנט לנסח שאלת מחקר אחת ברורה וממוקדת. תשובות קצרות בלבד (עד 3 משפטים).`}
                                    />
                                ) : view === 'search' ? (
                                    <AIChatComponent 
                                        title="חיפוש מקורות חכם" 
                                        subTitle="אמצא לך מקורות וקישורים."
                                        messages={sourceChatMessages}
                                        setMessages={setSourceChatMessages}
                                        withSearchTool={true}
                                        systemPrompt={`אתה ספרן דיגיטלי. מצא מקורות מידע וקישורים ישירים. תן תיאור של משפט אחד לכל מקור.`}
                                    />
                                ) : (
                                    <div className="pb-20">
                                        <h2 className="text-2xl md:text-3xl font-black mb-6 text-slate-900 px-2">{view}</h2>
                                        {allData[view]?.map(b => (
                                            <div key={b.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-6 hover:shadow-md transition-all">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className={`font-bold text-xs uppercase tracking-wider ${b.id.includes('sum') ? 'text-indigo-600' : 'text-slate-400'}`}>{b.title}</span>
                                                </div>
                                                <textarea 
                                                    className="w-full min-h-[100px] p-4 rounded-xl bg-slate-50 text-sm leading-relaxed outline-none border border-transparent focus:border-indigo-300 focus:bg-white transition-all resize-none mb-4" 
                                                    value={b.rawInput} 
                                                    onChange={e => handleUpdate(b.id, {rawInput: e.target.value})} 
                                                    placeholder="כתוב כאן נקודות, רעיונות או טיוטה ראשונית..." 
                                                />
                                                <div className="flex justify-end">
                                                    <button onClick={() => handleRefine(b.id)} disabled={b.isRefining || !b.rawInput.trim()} className="bg-indigo-600 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-md shadow-indigo-100 disabled:opacity-50 disabled:shadow-none">
                                                        {b.isRefining ? <div className="w-4 h-4 border-2 border-white border-t-transparent animate-spin rounded-full" /> : <Icon name="sparkles" size={16} />}
                                                        {b.isRefining ? 'מעבד...' : view === 'ביבליוגרפיה' ? 'עצב ציטוט' : 'הרחב וסגנן'}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                        <button 
                                            onClick={() => {
                                                const newId = `${view}-${Date.now()}`;
                                                setAllData(prev => ({
                                                    ...prev,
                                                    [view]: [...(prev[view] || []), { id: newId, title: view === 'ביבליוגרפיה' ? 'מקור חדש' : 'פסקה חדשה', rawInput: '', refinedContent: '' }]
                                                }));
                                            }}
                                            className="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold hover:border-indigo-500 hover:text-indigo-600 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Icon name="plus" size={20} />
                                            הוסף {view === 'ביבליוגרפיה' ? 'מקור' : 'פסקה'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </section>

                        <section className={`w-full md:w-[45%] bg-white p-4 md:p-12 overflow-y-auto border-r shadow-inner ${showMobilePreview ? 'block fixed inset-0 z-50 pt-20' : 'hidden md:block'}`}>
                             <div className="max-w-[21cm] mx-auto min-h-[29.7cm] font-serif" dir="rtl" style={{fontFamily: "'David', 'Times New Roman', serif"}}>
                                <h3 className="text-center font-bold border-b-2 border-black pb-4 mb-8 text-xl md:text-2xl text-black">{paperTitle}</h3>
                                {sections.map(sec => {
                                    const bubbles = allData[sec];
                                    if (!bubbles?.some(b => b.refinedContent)) return null;
                                    return (
                                        <div key={sec} className="mb-8">
                                            <h4 className="font-bold text-lg mb-4 text-black underline">{sec}</h4>
                                            {bubbles.map(b => b.refinedContent && (
                                                <div key={b.id} className={`text-[11pt] md:text-[12pt] leading-[1.5] text-black mb-4 text-justify preserve-lines ${sec === 'ביבליוגרפיה' ? 'pr-4 -indent-4' : ''}`}>
                                                    {b.refinedContent}
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                                {Object.values(allData).flat().every(b => !b.refinedContent) && (
                                    <div className="text-center py-40 text-slate-300 italic">הטקסט המוכח יופיע כאן...</div>
                                )}
                             </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
