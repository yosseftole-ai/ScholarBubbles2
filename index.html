<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
          authDomain: "cholar-bubbles.firebaseapp.com",
          projectId: "cholar-bubbles",
          storageBucket: "cholar-bubbles.firebasestorage.app",
          messagingSenderId: "965320932006",
          appId: "1:965320932006:web:eeeefce099c0422d4e9267",
          measurementId: "G-Q08F6MFNCD"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            
            window.fbFunctions = {
                signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
                signInAnonymously, doc, setDoc, updateDoc, deleteDoc, arrayUnion, 
                serverTimestamp, getDoc, collection, addDoc, onSnapshot,
                query, orderBy
            };
            window.firebaseInitialized = true;
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) { .chat-container { height: calc(100vh - 200px); } }
        .preserve-lines { white-space: pre-wrap; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useCallback } = React;
        const MotionLib = window.Motion || { motion: { div: 'div' }, AnimatePresence: ({children}) => <>{children}</> };
        const { motion, AnimatePresence } = MotionLib;

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                const pascalName = name.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
                const iconDef = window.lucide.icons ? window.lucide.icons[pascalName] : null;
                if (iconDef && window.lucide.createElement) {
                    ref.current.innerHTML = '';
                    const svg = window.lucide.createElement(iconDef);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    if (className) svg.setAttribute('class', className);
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-block', width: size, height: size }}></span>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text.replace(/\*\*/g, '').replace(/###/g, '').replace(/#/g, '').replace(/json/g, '').replace(/```/g, '').trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': { label: 'בית ספר יסודי (ד\'-ו\')', prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה.' },
            'middle-school': { label: 'חטיבת ביניים', prompt: 'תכתוב ברמת תלמיד בגיל 16 שכותב עבודה להגשה.' },
            'high-school': { label: 'תיכון', prompt: 'תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18.' },
            'academic': { label: 'אקדמי', prompt: 'כתוב בשפה אקדמית מלאה וגבוהה.' }
        };

        const INITIAL_DATA = {
            'תקציר': [{ id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' }, { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' }, { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' }, { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' }],
            'מבוא': [{ id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' }, { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' }, { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' }, { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' }],
            'גוף העבודה': [{ id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' }, { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' }, { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' }, { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' }, { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' }, { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' }, { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' }],
            'ממצאים': [{ id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' }, { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' }, { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' }, { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' }],
            'סיכום': [{ id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' }, { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' }],
            'ביבליוגרפיה': []
        };

        const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false, user, trackAction }) => {
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || loading) return;
                const userMsg = { role: 'user', text: input };
                const currentInput = input;
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setLoading(true);
                if(trackAction) trackAction(withSearchTool ? "search_query" : "research_chat", { query: currentInput });

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [...messages, userMsg],
                            systemPrompt: systemPrompt,
                            withSearch: withSearchTool
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Server Error");
                    }
                    
                    const data = await response.json();
                    let aiText = data.text || "מצטער, לא הצלחתי לעבד את הבקשה.";
                    
                    if (data.grounding) {
                        aiText += "\n\nמקורות שמצאתי:\n";
                        data.grounding.forEach(g => {
                            if (g.uri && g.title) aiText += `• [${g.title}](${g.uri})\n`;
                        });
                    }

                    setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(aiText) }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'ai', text: `שגיאה בתקשורת: ${e.message}` }]);
                }
                setLoading(false);
            };

            return (
                <div className="chat-container bg-white rounded-2xl border overflow-hidden shadow-sm h-full flex flex-col">
                    <div className="p-4 border-b bg-slate-50">
                        <h2 className="text-xl font-black text-indigo-600 flex items-center gap-2">{title}</h2>
                        <p className="text-xs text-slate-500">{subTitle}</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-white" ref={scrollRef}>
                        {messages.length === 0 && <div className="text-center text-slate-400 py-10">התחל שיחה...</div>}
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-slate-100 text-slate-800' : 'bg-indigo-50 text-indigo-900 border border-indigo-100'}`}>
                                    {m.text.split('\n').map((line, idx) => {
                                        const parts = line.split(/(\[(?:.*?)\]\((?:.*?)\)|https?:\/\/[^\s]+)/g);
                                        return <div key={idx}>{parts.map((part, pIdx) => {
                                            const mdLink = part.match(/\[(.*?)\]\((.*?)\)/);
                                            if (mdLink) return <a key={pIdx} href={mdLink[2]} target="_blank" className="text-blue-600 underline font-bold">{mdLink[1]}</a>;
                                            if (part.match(/^https?:\/\//)) return <a key={pIdx} href={part} target="_blank" className="text-blue-600 underline break-all">{part}</a>;
                                            return <span key={pIdx}>{part}</span>;
                                        })}</div>;
                                    })}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 animate-pulse">מקליד...</div>}
                    </div>
                    <div className="p-3 bg-white border-t flex gap-2">
                        <input className="flex-1 px-4 py-2 border rounded-full text-sm outline-none" placeholder="כתוב כאן..." value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} />
                        <button onClick={sendMessage} className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center"><Icon name="send" size={16} /></button>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const { signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, doc, setDoc, serverTimestamp } = window.fbFunctions;
            const auth = window.fbAuth;
            const db = window.fbDb;

            const saveUserToDB = async (user) => {
                try {
                    const userRef = doc(db, 'users', user.uid);
                    await setDoc(userRef, { email: user.email, displayName: user.displayName || 'משתמש', lastLogin: serverTimestamp(), uid: user.uid }, { merge: true });
                } catch (e) { console.error(e); }
            };

            const handleGoogleSignIn = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { setError('שגיאה בהתחברות עם גוגל'); }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let result = isRegistering ? await createUserWithEmailAndPassword(auth, email, password) : await signInWithEmailAndPassword(auth, email, password);
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { setError(isRegistering ? 'שגיאה בהרשמה' : 'פרטים שגויים'); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-3xl text-center max-w-md w-full shadow-2xl">
                        <h2 className="text-2xl font-black mb-4 italic text-indigo-600">ScholarBubbles</h2>
                        <button onClick={handleGoogleSignIn} className="w-full border p-3 rounded-xl mb-4 font-bold flex justify-center gap-2 items-center hover:bg-slate-50 transition-all"><Icon name="chrome" size={18} /> המשך עם Google</button>
                        <form onSubmit={handleEmailAuth} className="space-y-3">
                            <input type="email" placeholder="אימייל" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-xl outline-none focus:border-indigo-500" required />
                            <input type="password" placeholder="סיסמה" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-xl outline-none focus:border-indigo-500" required />
                            {error && <p className="text-red-500 text-xs">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold">{loading ? 'טוען...' : (isRegistering ? 'הרשמה' : 'כניסה')}</button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="mt-4 text-xs text-indigo-500 underline">{isRegistering ? 'יש לך חשבון? התחבר' : 'אין לך חשבון? הירשם'}</button>
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ user, onSelect, onLogout }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-3xl w-full max-w-4xl flex flex-col md:flex-row h-auto md:h-[80vh] shadow-2xl overflow-hidden">
                    <div className="md:w-1/2 bg-indigo-600 text-white p-8 flex flex-col justify-center items-center text-center">
                        <Icon name="book-open" size={64} className="mb-4" />
                        <h1 className="text-4xl font-black mb-2">ScholarBubbles</h1>
                        <p className="opacity-80">Toledano EdTech</p>
                        <div className="mt-6 text-xs bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">{user.email}</div>
                    </div>
                    <div className="md:w-1/2 p-8 overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-8 text-slate-800">בחר/י רמת כתיבה:</h2>
                        <div className="space-y-4">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button key={key} onClick={() => onSelect(key)} className="w-full text-right p-5 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-between items-center group"><span className="font-bold text-slate-700 group-hover:text-indigo-700">{info.label}</span><Icon name="chevron-left" className="text-slate-300 group-hover:text-indigo-500" /></button>
                            ))}
                        </div>
                        <button onClick={onLogout} className="mt-10 text-sm text-red-500 flex items-center gap-2 font-medium hover:underline"><Icon name="log-out" size={16} /> התנתק מהמערכת</button>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projectsList, setProjectsList] = useState([]);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [saveStatus, setSaveStatus] = useState('saved'); 
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [showMobilePreview, setShowMobilePreview] = useState(false);
            const sections = ['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'];

            useEffect(() => {
                const timer = setTimeout(() => setLoadingAuth(false), 3000);
                const checkFirebase = () => {
                    if (window.fbFunctions) {
                        window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                            setUser(u);
                            setLoadingAuth(false);
                            if (u) loadProjectsList(u.uid);
                        });
                    } else {
                        window.addEventListener('firebase-ready', () => {
                            window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                                setUser(u);
                                setLoadingAuth(false);
                                if (u) loadProjectsList(u.uid);
                            });
                        });
                    }
                };
                checkFirebase();
                return () => clearTimeout(timer);
            }, []);

            const loadProjectsList = (uid) => {
                const q = window.fbFunctions.query(window.fbFunctions.collection(window.fbDb, "users", uid, "projects"), window.fbFunctions.orderBy("lastUpdated", "desc"));
                window.fbFunctions.onSnapshot(q, (snapshot) => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjectsList(projects);
                    if (projects.length > 0 && !currentProjectId) loadProject(projects[0]);
                });
            };

            const loadProject = (project) => {
                setCurrentProjectId(project.id);
                setPaperTitle(project.paperTitle);
                setAllData(project.allData || INITIAL_DATA);
                if (project.level) setLevel(project.level);
            };

            const deleteProject = async (e, projectId) => {
                e.stopPropagation();
                if (!confirm("למחוק עבודה זו?")) return;
                try {
                    await window.fbFunctions.deleteDoc(window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", projectId));
                    if (projectId === currentProjectId) createNewProject();
                } catch (err) { alert("שגיאה במחיקה"); }
            };

            const createNewProject = () => {
                setCurrentProjectId(null);
                setPaperTitle('עבודה חדשה');
                setAllData(INITIAL_DATA);
                setLevel(null);
            };

            useEffect(() => {
                if (!user || !level) return;
                const timeoutId = setTimeout(() => saveUserData(), 2000);
                return () => clearTimeout(timeoutId);
            }, [allData, paperTitle, level]);

            const saveUserData = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    const projectData = { paperTitle, allData, level, lastUpdated: window.fbFunctions.serverTimestamp() };
                    if (currentProjectId) {
                        await window.fbFunctions.updateDoc(window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", currentProjectId), projectData);
                    } else {
                        const docRef = await window.fbFunctions.addDoc(window.fbFunctions.collection(window.fbDb, "users", user.uid, "projects"), projectData);
                        setCurrentProjectId(docRef.id);
                    }
                    setSaveStatus('saved');
                } catch (e) { setSaveStatus('error'); }
            };

            const trackAction = async (actionType, details = {}) => {
                if (!user || !window.fbDb) return;
                try { await window.fbFunctions.addDoc(window.fbFunctions.collection(window.fbDb, 'users', user.uid, 'activity_log'), { action: actionType, ...details, timestamp: window.fbFunctions.serverTimestamp() }); } catch (e) {}
            };

            const handleUpdate = (id, updates) => {
                setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, ...updates} : b) }));
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                handleUpdate(id, { isRefining: true });
                trackAction("refine_attempt", { section: view });

                const isBib = view === 'ביבליוגרפיה';
                let promptText = isBib 
                    ? `עצב כציטוט ביבליוגרפי תקני: "${bubble.rawInput}". החזר רק את הציטוט.`
                    : `הנושא: ${paperTitle}. פרק: ${view}. רמה: ${WRITING_LEVELS[level].prompt}.
                    תוכן קודם: ${allData[view].filter(b => b.id !== id && b.refinedContent).map(b => b.refinedContent).join("\n")}
                    תוכן לבועה זו: "${bubble.rawInput}".
                    משימה: כתוב פסקה מלאה ועשירה (200+ מילים), עם חלוקה לפסקאות משנה. בלי כותרות/פתיחים.`;

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            messages: [{ role: 'user', text: promptText }],
                            systemPrompt: "אתה עורך אקדמי מקצועי. הפוך נקודות לפסקאות זורמות ומעמיקות.",
                            withSearch: false
                        })
                    });
                    
                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.error || "API Error");
                    }
                    
                    const resJson = await response.json();
                    const text = resJson.text || "שגיאה בעיבוד התשובה";
                    handleUpdate(id, { refinedContent: cleanMarkdown(text), isRefining: false });
                } catch (e) { 
                    alert(`שגיאה ב-AI: ${e.message}`); 
                    handleUpdate(id, { isRefining: false }); 
                }
            };

            const downloadAsWord = () => {
                const styles = `<style>@page{size:A4;margin:2.54cm}body{direction:rtl;text-align:right;font-family:'David',serif;font-size:12pt;line-height:150%}h1{font-size:16pt;font-weight:bold;text-align:center;margin-bottom:24pt}h2{font-size:14pt;font-weight:bold;margin-top:18pt;border-bottom:1px solid #000}p{margin-bottom:12pt;text-align:right}</style>`;
                let content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='[http://www.w3.org/TR/REC-html40](http://www.w3.org/TR/REC-html40)'><head><meta charset='utf-8'><title>${paperTitle}</title>${styles}</head><body><h1>${paperTitle}</h1>${sections.map(sec => {
                    const bubbles = allData[sec];
                    if (bubbles?.some(b => b.refinedContent)) {
                        return `<h2>${sec}</h2>` + bubbles.map(b => b.refinedContent ? `<p>${b.refinedContent.replace(/\n/g, '<br>')}</p>` : '').join('');
                    }
                    return '';
                }).join('')}</body></html>`;
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${paperTitle}.doc`;
                link.click();
            };

            if (loadingAuth) return <div className="flex h-screen items-center justify-center text-indigo-600 font-bold bg-slate-50 text-xl animate-pulse italic">ScholarBubbles...</div>;
            if (!user) return <AuthScreen onAuthSuccess={setUser} />;
            if (!level) return <WelcomeScreen user={user} onSelect={(l)=>{setLevel(l); trackAction("level_selected", {level:l})}} onLogout={() => window.fbFunctions.signOut(window.fbAuth)} />;

            return (
                <div className="flex h-[100dvh] overflow-hidden bg-white flex-col md:flex-row font-sans" dir="rtl">
                    <div className="md:hidden flex items-center justify-between p-4 bg-slate-900 text-white shadow-md z-50">
                        <div className="flex items-center gap-4"><div className="flex items-center gap-2 font-bold"><Icon name="book-open" size={20} className="text-indigo-400" /> ScholarBubbles</div><button onClick={() => setShowMobilePreview(!showMobilePreview)} className="flex items-center gap-1 text-sm bg-slate-800 px-3 py-1 rounded-full">{showMobilePreview ? <><Icon name="edit-3" size={14} /> עריכה</> : <><Icon name="eye" size={14} /> תצוגה</>}</button></div>
                        <div className="flex items-center gap-4"><button onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><Icon name={mobileMenuOpen ? "x" : "menu"} /></button></div>
                    </div>
                    <aside className={`fixed inset-y-0 right-0 z-40 w-64 bg-slate-900 text-white p-6 transform transition-transform duration-300 ${mobileMenuOpen ? 'translate-x-0' : 'translate-x-full'} md:relative md:translate-x-0 md:block shadow-xl`}>
                        <div className="mb-6 cursor-pointer" onClick={() => setLevel(null)}><h1 className="text-xl font-bold flex items-center gap-3"><Icon name="book-open" className="text-indigo-400" /> ScholarBubbles</h1><div className="text-[10px] mt-2 bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded inline-block">רמת {WRITING_LEVELS[level].label}</div></div>
                        <div className="mb-6"><h3 className="text-xs font-bold text-slate-500 uppercase mb-2">העבודות שלי</h3><div className="space-y-1 max-h-32 overflow-y-auto"><button onClick={createNewProject} className="w-full text-right p-2 rounded text-xs text-indigo-300 hover:bg-slate-800 flex items-center gap-2"><Icon name="plus" size={12}/> עבודה חדשה</button>{projectsList.map(p => (<div key={p.id} className={`group flex items-center justify-between p-2 rounded text-xs ${currentProjectId === p.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}`}><button onClick={() => loadProject(p)} className="truncate w-full text-right">{p.paperTitle || 'ללא כותרת'}</button><button onClick={(e) => deleteProject(e, p.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 px-1"><Icon name="trash-2" size={12}/></button></div>))}</div></div>
                        <nav className="flex-1 space-y-1 overflow-y-auto max-h-[calc(100vh-350px)]">
                            <button onClick={() => {setView('question'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-2 border border-slate-700 flex items-center gap-2 ${view === 'question' ? 'bg-indigo-600 font-bold' : 'hover:bg-slate-800 text-slate-400'}`}><Icon name="help-circle" size={14}/> שאלת מחקר AI</button>
                            <button onClick={() => {setView('search'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-6 border border-slate-700 flex items-center gap-2 ${view === 'search' ? 'bg-indigo-600 font-bold' : 'hover:bg-slate-800 text-slate-400'}`}><Icon name="search" size={14}/> חיפוש מקורות AI</button>
                            <div className="text-[10px] text-slate-500 font-bold uppercase mb-2 mr-2">כתיבת העבודה</div>{sections.map(s => (<button key={s} onClick={() => {setView(s); setMobileMenuOpen(false);}} className={`w-full text-right flex items-center justify-between p-3 rounded-xl text-sm transition-all ${view === s ? 'bg-indigo-600 font-bold text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>{s}{allData[s]?.some(b => b.refinedContent) && <Icon name="check-circle" size={14} className="text-emerald-400" />}</button>))}
                        </nav>
                        <div className="mt-4 pt-4 border-t border-slate-800"><div className="text-[10px] text-slate-500 mb-1 truncate">{user.email}</div><div className={`text-[10px] font-bold ${saveStatus==='error'?'text-red-400':'text-emerald-400'}`}>{saveStatus==='saving'?'שומר...':saveStatus==='error'?'שגיאה':'נשמר בהצלחה'}</div><button onClick={downloadAsWord} className="w-full mt-4 bg-emerald-600 text-white p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-emerald-700 transition-colors"><Icon name="download" size={14} /> הורד קובץ Word</button></div>
                    </aside>
                    {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setMobileMenuOpen(false)} />}
                    <main className="flex-1 flex overflow-hidden relative">
                        <section className={`flex-1 p-6 md:p-10 overflow-y-auto ${showMobilePreview ? 'hidden md:block' : 'block'}`}>
                            <div className="max-w-3xl mx-auto pb-20">
                                <input className="w-full bg-transparent text-2xl md:text-4xl font-black mb-6 border-b-2 border-transparent focus:border-indigo-500 outline-none transition-all py-2" value={paperTitle} onChange={e=>setPaperTitle(e.target.value)} placeholder="כתוב כותרת לעבודה..." />
                                {view === 'question' ? <AIChatComponent title="גיבוש שאלת מחקר" subTitle="ניסוח שאלת מחקר מדויקת היא הצעד החשוב ביותר." messages={questionChatMessages} setMessages={setQuestionChatMessages} systemPrompt="אתה מנחה אקדמי מנוסה. עזור לסטודנט לנסח שאלת מחקר אחת ברורה. תשובות קצרות ומקצועיות." trackAction={trackAction} user={user} /> :
                                 view === 'search' ? <AIChatComponent title="חיפוש מקורות חכם" subTitle="חיפוש מקורות אקדמיים רלוונטיים." messages={sourceChatMessages} setMessages={setSourceChatMessages} withSearchTool={true} systemPrompt="אתה ספרן דיגיטלי. מצא מקורות מידע וקישורים ישירים. תן תיאור קצר לכל מקור." trackAction={trackAction} user={user} /> :
                                 (<div className="pb-20"><h2 className="text-2xl md:text-3xl font-black mb-8 text-slate-900 px-2 flex items-center gap-3">{view} <span className="h-1 flex-1 bg-slate-100 rounded-full"></span></h2>{allData[view]?.map(b => (
                                    <div key={b.id} className="group bg-white rounded-3xl shadow-sm border border-slate-200 p-5 md:p-8 mb-8 hover:shadow-xl hover:border-indigo-100 transition-all duration-300">
                                        <div className="flex justify-between items-center mb-4"><span className={`font-bold text-xs uppercase tracking-widest ${b.id.includes('sum') ? 'text-indigo-600' : 'text-slate-400'}`}>{b.title}</span><button onClick={() => { if(confirm("למחוק פסקה זו?")) setAllData(prev => ({...prev, [view]: prev[view].filter(x => x.id !== b.id)})); }} className="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={16} /></button></div>
                                        <textarea className="w-full min-h-[120px] p-5 rounded-2xl bg-slate-50 text-base leading-relaxed outline-none border-2 border-transparent focus:border-indigo-200 focus:bg-white transition-all resize-none mb-6 font-medium" value={b.rawInput} onChange={e => handleUpdate(b.id, {rawInput: e.target.value})} placeholder="כתוב כאן נקודות, רעיונות או ציטוטים..." />
                                        <div className="flex justify-end"><button onClick={() => handleRefine(b.id)} disabled={b.isRefining || !b.rawInput.trim()} className="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-sm font-bold flex items-center gap-3 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 disabled:opacity-50 disabled:shadow-none hover:scale-105 active:scale-95">{b.isRefining ? <div className="w-5 h-5 border-3 border-white border-t-transparent animate-spin rounded-full" /> : <Icon name="sparkles" size={18} />}{b.isRefining ? 'כותב עבורך...' : 'סגנן והרחב עם AI'}</button></div>
                                    </div>
                                ))}
                                <button onClick={() => { const newId = `${view}-${Date.now()}`; setAllData(prev => ({ ...prev, [view]: [...(prev[view] || []), { id: newId, title: view === 'ביבליוגרפיה' ? 'מקור חדש' : 'פסקה חדשה', rawInput: '', refinedContent: '' }] })); }} className="w-full py-6 border-2 border-dashed border-slate-300 rounded-3xl text-slate-400 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50/30 transition-all flex items-center justify-center gap-3 group"><Icon name="plus" size={24} className="group-hover:rotate-90 transition-transform" /> הוסף {view === 'ביבליוגרפיה' ? 'מקור' : 'פסקה חדשה'}</button></div>)}
                            </div>
                        </section>
                        <section className={`w-full md:w-[45%] bg-white p-12 overflow-y-auto border-r shadow-inner ${showMobilePreview ? 'block fixed inset-0 z-50 pt-20' : 'hidden md:block'}`}>
                            {showMobilePreview && <button onClick={() => setShowMobilePreview(false)} className="absolute top-4 left-4 bg-slate-100 p-3 rounded-full shadow-md z-[60]"><Icon name="x" /></button>}
                             <div className="max-w-[19cm] mx-auto min-h-[29.7cm] font-serif bg-white p-8 md:p-12 shadow-sm border border-slate-100" dir="rtl" style={{fontFamily: "'Assistant', 'Times New Roman', serif"}}>
                                <h3 className="text-center font-bold border-b-2 border-black pb-6 mb-12 text-2xl md:text-3xl text-black">{paperTitle}</h3>
                                {sections.map(sec => {
                                    const bubbles = allData[sec];
                                    if (!bubbles?.some(b => b.refinedContent)) return null;
                                    return (<div key={sec} className="mb-10"><h4 className="font-bold text-xl mb-6 text-black underline decoration-slate-300 underline-offset-8">{sec}</h4>{bubbles.map(b => b.refinedContent && (<div key={b.id} className={`text-[12pt] leading-[1.8] text-slate-900 mb-6 text-justify preserve-lines ${sec === 'ביבליוגרפיה' ? 'pr-6 -indent-6 font-sans italic' : ''}`}>{b.refinedContent}</div>))}</div>);
                                })}
                             </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
