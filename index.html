<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Bubbles - מקומי</title>
    
    <!-- טעינת העיצוב (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- הגדרת מפת הייבוא - קריטי כדי שהדפדפן ידע מאיפה להביא את React ופיירבייס -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.3.1",
            "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.3.1,react-dom@18.3.1",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.3.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- טעינת Babel כדי לפענח את ה-React בדפדפן -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <!-- כאן מתחיל הקוד של האתר -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword } from "firebase/auth";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, collection, addDoc, onSnapshot } from "firebase/firestore";
        import { 
            BookOpen, ChevronLeft, ShieldCheck, User, Download, Sparkles, Plus, Send, Search, 
            HelpCircle, X, Menu, Eye, Edit3, CheckCircle, LogOut, Wand2, Trash2, ExternalLink, Loader2, Mail, AlertTriangle
        } from 'lucide-react';

        // --- הגדרות ---

        // ההגדרות שלך מפיירבייס (נלקחו מהקוד שסיפקת)
        const firebaseConfig = {
  apiKey: "AIzaSyBmjoDMOZ3tfWNkkHhZM6QfYbWYbW_TMOk",
  authDomain: "bubbles-62f45.firebaseapp.com",
  projectId: "bubbles-62f45",
  storageBucket: "bubbles-62f45.firebasestorage.app",
  messagingSenderId: "549730760870",
  appId: "1:549730760870:web:6fb70a41809aaa66ee1c67",
  measurementId: "G-SD85C3NWGC"
};

        const apiKey = ""; // Gemini API Key (אם יש לך, הכנס כאן)
        const appId = 'scholar-bubbles-local';

        // אתחול Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- לוגיקה וקבועים ---

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text
                .replace(/\*\*/g, '')
                .replace(/###/g, '')
                .replace(/#/g, '')
                .replace(/json/g, '')
                .replace(/```/g, '')
                .replace(/^(הנה|להלן|ובכן|תשובה|הפסקה|פסקה|תוכן).*?[:\n]/s, '')
                .replace(/^[א-ת]\s*\n/s, '') 
                .trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': {
                label: 'בית ספר יסודי (ד\'-ו\')',
                prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה. שפה נעימה, ברורה ולא מסובכת.'
            },
            'middle-school': { 
                label: 'חטיבת ביניים', 
                prompt: 'כתוב בשפה תקנית, מכובדת ורצינית המתאימה לעבודת הגשה בחטיבת ביניים. הימנע מסלנג או שפה מדוברת ("דיבור רחוב"), אך שמור על בהירות. השתמש במשפטים מלאים ומובנים, ללא מונחים אקדמיים מסובכים מדי.' 
            },
            'high-school': { 
                label: 'תיכון', 
                prompt: 'חשוב ביותר: תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18 (עבודת גמר בתיכון). רמה גבוהה, תקנית ועשירה, מבנה לוגי מורכב.' 
            },
            'academic': { 
                label: 'אקדמי', 
                prompt: 'כתוב בשפה אקדמית מלאה וגבוהה. השתמש בטרמינולוגיה מחקרית, משפטים מורכבים וניסוחים אובייקטיביים.' 
            }
        };

        const INITIAL_DATA = {
            'תקציר': [
                { id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' },
                { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' },
                { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' },
                { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' }
            ],
            'מבוא': [
                { id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' },
                { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' },
                { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' },
                { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' }
            ],
            'גוף העבודה': [
                { id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' },
                { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' },
                { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' },
                { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' },
                { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' },
                { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' },
                { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' }
            ],
            'ממצאים': [
                { id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' },
                { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' },
                { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' },
                { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' }
            ],
            'סיכום': [
                { id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' },
                { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' },
                { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' }
            ],
            'ביבליוגרפיה': []
        };

        // --- קומפוננטות ---

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const saveUserToDB = async (user) => {
                try {
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    await setDoc(userRef, {
                        email: user.email,
                        displayName: user.displayName || 'משתמש',
                        lastLogin: serverTimestamp(),
                        uid: user.uid
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving user to DB:", e);
                }
            };

            const handleGoogleSignIn = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { 
                    console.error("Google Login Error:", err);
                    if (err.code === 'auth/unauthorized-domain') {
                        setError('שגיאה: הדומיין אינו מורשה. יש להוסיף את הדומיין הנוכחי (למשל localhost) לרשימת Authorized Domains במסוף Firebase (תחת Authentication -> Settings).');
                    } else if (err.code === 'auth/popup-closed-by-user') {
                        setError('החלון נסגר לפני סיום ההתחברות.');
                    } else if (err.code === 'auth/popup-blocked') {
                        setError('הדפדפן חסם את החלון הקופץ. אנא אפשר חלונות קופצים לאתר זה.');
                    } else {
                        setError(`שגיאה בהתחברות: ${err.message}`);
                    }
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let result;
                    if (isRegistering) {
                        result = await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        result = await signInWithEmailAndPassword(auth, email, password);
                    }
                    await saveUserToDB(result.user);
                    onAuthSuccess(result.user);
                } catch (err) { 
                    console.error("Email Login Error:", err);
                    if (err.code === 'auth/wrong-password') {
                        setError('הסיסמה שגויה.');
                    } else if (err.code === 'auth/user-not-found') {
                        setError('לא נמצא משתמש עם האימייל הזה.');
                    } else if (err.code === 'auth/email-already-in-use') {
                        setError('האימייל הזה כבר נמצא בשימוש.');
                    } else if (err.code === 'auth/weak-password') {
                        setError('הסיסמה חלשה מדי (חייבת להיות לפחות 6 תווים).');
                    } else {
                        setError('שגיאה בהתחברות/הרשמה. בדוק את הפרטים ונסה שוב.');
                    }
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4 overflow-y-auto" dir="rtl">
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-full h-2 bg-indigo-600"></div>
                        <div className="mb-6 flex justify-center"><ShieldCheck size={48} className="text-indigo-600" /></div>
                        <h2 className="text-2xl font-black mb-2 tracking-tight">ברוכים הבאים ל-ScholarBubbles</h2>
                        
                        <button onClick={handleGoogleSignIn} className="w-full flex items-center justify-center gap-3 border-2 border-slate-100 p-3 rounded-xl hover:bg-slate-50 transition-all mb-6">
                            <span className="font-bold">המשך עם Google</span>
                        </button>

                        <div className="relative mb-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-100"></div></div>
                            <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">או הזדהות רגילה</span></div>
                        </div>

                        <form onSubmit={handleEmailAuth} className="space-y-4 text-right">
                            <input type="email" placeholder="אימייל" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border" required />
                            <input type="password" placeholder="סיסמה" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border" required />
                            {error && (
                                <div className="text-red-600 text-xs bg-red-50 p-2 rounded border border-red-100 flex items-start gap-2 text-right">
                                    <AlertTriangle size={14} className="shrink-0 mt-0.5" />
                                    <span>{error}</span>
                                </div>
                            )}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700">
                                {loading ? <Loader2 className="animate-spin mx-auto" /> : (isRegistering ? 'הרשמה' : 'כניסה')}
                            </button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="mt-4 text-xs text-indigo-500 hover:underline">
                            {isRegistering ? 'יש לך כבר חשבון? התחבר' : 'אין לך חשבון? הירשם כאן'}
                        </button>
                    </motion.div>
                </div>
            );
        };

        const WelcomeScreen = ({ user, onSelect, onLogout }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4 text-right" dir="rtl">
                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="max-w-4xl w-full bg-white rounded-2xl p-8 flex flex-col md:flex-row">
                    <div className="md:w-1/2 bg-indigo-600 p-8 text-white rounded-xl">
                        <BookOpen size={48} className="mb-4 text-indigo-200" />
                        <h1 className="text-3xl font-black mb-2">ScholarBubbles</h1>
                        <p>שלום, {user.displayName || user.email}</p>
                    </div>
                    <div className="md:w-1/2 p-8 bg-white">
                        <h2 className="text-xl font-bold mb-6 text-slate-800">בחר/י רמת כתיבה:</h2>
                        <div className="space-y-3">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button key={key} onClick={() => onSelect(key)} className="w-full text-right p-4 rounded-xl border hover:bg-indigo-50 flex justify-between">
                                    <span className="font-bold">{info.label}</span>
                                    <ChevronLeft size={20} />
                                </button>
                            ))}
                        </div>
                        <button onClick={onLogout} className="mt-8 flex gap-2 text-sm text-slate-400 hover:text-red-500"><LogOut size={16}/> התנתק</button>
                    </div>
                </motion.div>
            </div>
        );

        // --- קומפוננטה ראשית ---

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [showMobilePreview, setShowMobilePreview] = useState(false);

            const sections = ['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'];

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            const trackAction = async (actionType, details = {}) => {
                if (!user) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'activity_log'), {
                        action: actionType,
                        ...details,
                        timestamp: serverTimestamp()
                    });
                } catch (e) { console.error("Tracking error", e); }
            };

            const handleLevelSelect = (l) => {
                setLevel(l);
                trackAction("level_selected", { level: l });
            };

            const handleUpdate = (id, updates) => {
                setAllData(prev => ({ ...prev, [view]: prev[view].map(b => b.id === id ? {...b, ...updates} : b) }));
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                const isBibliography = view === 'ביבליוגרפיה';
                handleUpdate(id, { isRefining: true });
                
                trackAction("refine_attempt", { section: view, bubbleId: id });

                let promptText = '';
                
                if (isBibliography) {
                    promptText = `המטרה: יצירת פריט ביבליוגרפי תקני ומדויק.
                    קח את המידע הגולמי: "${bubble.rawInput}".
                    עצב אותו לפי "כללי הציטוט האחיד" או APA.
                    החזר רק את השורה הביבליוגרפית המעוצבת, ללא טקסט נוסף.`;
                } else {
                    const previousContent = allData[view]
                        .slice(0, allData[view].findIndex(b => b.id === id))
                        .map(b => b.refinedContent)
                        .filter(Boolean)
                        .join("\n\n");

                    promptText = `הנושא: ${paperTitle}. הפרק: ${view}.
                    הנחיית רמה: ${WRITING_LEVELS[level].prompt}
                    טקסט קודם: ${previousContent || "זוהי תחילת הפרק"}
                    מידע גולמי: "${bubble.rawInput}"
                    משימה: כתוב פסקה מורחבת (לפחות 150-200 מילים).`;
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    const resJson = await response.json();
                    const text = resJson.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    handleUpdate(id, { refinedContent: cleanMarkdown(text), isRefining: false });
                    trackAction("refine_success", { section: view });
                } catch (e) { handleUpdate(id, { isRefining: false }); }
            };

            const downloadAsWord = () => {
                trackAction("download_word");
                const content = `
                    <html dir="rtl"><body>
                    <h1>${paperTitle}</h1>
                    ${sections.map(sec => {
                        const bubbles = allData[sec];
                        if (!bubbles?.some(b => b.refinedContent)) return '';
                        return `<h2>${sec}</h2>` + bubbles.map(b => b.refinedContent ? `<p>${b.refinedContent}</p>` : '').join('');
                    }).join('')}
                    </body></html>
                `;
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${paperTitle}.doc`;
                link.click();
            };

            const AIChatComponent = ({ title, subTitle, systemPrompt, messages, setMessages, withSearchTool = false }) => {
                const [input, setInput] = useState('');
                const [loading, setLoading] = useState(false);
                const scrollRef = useRef(null);

                useEffect(() => {
                    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }, [messages]);

                const sendMessage = async () => {
                    if (!input.trim() || loading) return;
                    const userMsg = { role: 'user', text: input };
                    setMessages(prev => [...prev, userMsg]);
                    setInput('');
                    setLoading(true);

                    try {
                        const payload = {
                            contents: [...messages, userMsg].map(m => ({ role: m.role === 'ai' ? 'model' : 'user', parts: [{ text: m.text }] })),
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        };
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "מצטער, לא הצלחתי לעבד את הבקשה.";
                        setMessages(prev => [...prev, { role: 'ai', text: cleanMarkdown(aiText) }]);
                    } catch (e) {
                        setMessages(prev => [...prev, { role: 'ai', text: "שגיאה בתקשורת עם השרת." }]);
                    }
                    setLoading(false);
                };

                return (
                    <div className="bg-white rounded-2xl border h-[500px] flex flex-col">
                        <div className="p-4 border-b">
                            <h2 className="font-bold text-indigo-600">{title}</h2>
                            <p className="text-xs text-slate-500">{subTitle}</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                            {messages.map((m, i) => (
                                <div key={i} className={`p-3 rounded-lg text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-slate-100' : 'bg-indigo-50 border'}`}>
                                    {m.text}
                                </div>
                            ))}
                        </div>
                        <div className="p-3 border-t flex gap-2">
                            <input className="flex-1 p-2 border rounded-full" value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} />
                            <button onClick={sendMessage} className="p-2 bg-indigo-600 text-white rounded-full"><Send size={16}/></button>
                        </div>
                    </div>
                );
            };

            if (loadingAuth) return <div className="flex h-screen items-center justify-center"><Loader2 className="animate-spin" size={48}/></div>;
            if (!user) return <AuthScreen onAuthSuccess={setUser} />;
            if (!level) return <WelcomeScreen user={user} onSelect={handleLevelSelect} onLogout={() => signOut(auth)} />;

            return (
                <div className="flex h-screen bg-white flex-col md:flex-row font-sans" dir="rtl">
                    <aside className={`fixed inset-y-0 right-0 z-40 w-64 bg-slate-900 text-white p-6 transition-transform ${mobileMenuOpen ? 'translate-x-0' : 'translate-x-full'} md:relative md:translate-x-0`}>
                        <h1 className="text-xl font-bold flex gap-2 cursor-pointer" onClick={() => setLevel(null)}>
                            <BookOpen className="text-indigo-400" /> ScholarBubbles
                        </h1>
                        <div className="text-xs mt-1 text-indigo-300">רמה: {WRITING_LEVELS[level].label}</div>
                        <nav className="mt-8 space-y-1">
                             <button onClick={() => {setView('question'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-2 ${view === 'question' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}>שאלת מחקר AI</button>
                             <button onClick={() => {setView('search'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-6 ${view === 'search' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}>חיפוש מקורות AI</button>
                            {sections.map(s => (
                                <button key={s} onClick={() => {setView(s); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm ${view === s ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}>
                                    {s}
                                </button>
                            ))}
                        </nav>
                        <button onClick={downloadAsWord} className="mt-8 w-full bg-emerald-600 p-2 rounded-xl flex justify-center gap-2 text-sm font-bold">
                            <Download size={16}/> הורד Word
                        </button>
                    </aside>

                    <main className="flex-1 flex overflow-hidden">
                        <section className="flex-1 p-8 overflow-y-auto bg-slate-50">
                            <div className="max-w-3xl mx-auto">
                                <button className="md:hidden mb-4" onClick={() => setMobileMenuOpen(true)}><Menu/></button>
                                <input className="w-full text-2xl font-black bg-transparent mb-6 outline-none" value={paperTitle} onChange={e => setPaperTitle(e.target.value)} />
                                
                                {view === 'question' ? (
                                    <AIChatComponent 
                                        title="גיבוש שאלת מחקר" 
                                        subTitle="אני אעזור לך לחדד ולנסח את שאלת המחקר המדויקת ביותר."
                                        messages={questionChatMessages}
                                        setMessages={setQuestionChatMessages}
                                        systemPrompt="אתה מנחה אקדמי מנוסה..."
                                    />
                                ) : view === 'search' ? (
                                    <AIChatComponent 
                                        title="חיפוש מקורות" 
                                        subTitle="אני אמצא לך מקורות מידע."
                                        messages={sourceChatMessages}
                                        setMessages={setSourceChatMessages}
                                        withSearchTool={true}
                                        systemPrompt="אתה עוזר מחקר..."
                                    />
                                ) : (
                                    <>
                                        <h2 className="text-2xl font-bold mb-4">{view}</h2>
                                        {allData[view]?.map(b => (
                                            <div key={b.id} className="bg-white rounded-xl shadow p-4 mb-4">
                                                <div className="text-xs text-slate-400 font-bold mb-2">{b.title}</div>
                                                <textarea 
                                                    className="w-full p-3 bg-slate-50 rounded-lg min-h-[100px]" 
                                                    value={b.rawInput} 
                                                    onChange={e => handleUpdate(b.id, {rawInput: e.target.value})}
                                                    placeholder="כתוב כאן נקודות..."
                                                />
                                                <button onClick={() => handleRefine(b.id)} className="bg-indigo-600 text-white px-3 py-1 rounded text-sm mt-2">
                                                    {b.isRefining ? 'מעבד...' : 'עבד עם AI'}
                                                </button>
                                            </div>
                                        ))}
                                    </>
                                )}
                            </div>
                        </section>
                        
                        <section className="hidden md:block w-[40%] bg-white p-12 border-r shadow-inner overflow-y-auto">
                            <div className="font-serif text-lg leading-relaxed">
                                <h1 className="text-center text-2xl font-bold border-b-2 border-black pb-4 mb-8">{paperTitle}</h1>
                                {sections.map(sec => (
                                    <div key={sec} className="mb-6">
                                        <h3 className="font-bold underline mb-2">{sec}</h3>
                                        {allData[sec].map(b => b.refinedContent && <p key={b.id} className="mb-4">{b.refinedContent}</p>)}
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
