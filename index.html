<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScholarBubbles - Toledano EdTech</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, getDoc, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- מקום להדבקת הגדרות FIREBASE ---
        const firebaseConfig = {
  apiKey: "AIzaSyDT5flU7tNbivQ3aadqFJnGqgtSs-uikGo",
  authDomain: "cholar-bubbles.firebaseapp.com",
  projectId: "cholar-bubbles",
  storageBucket: "cholar-bubbles.firebasestorage.app",
  messagingSenderId: "965320932006",
  appId: "1:965320932006:web:eeeefce099c0422d4e9267",
  measurementId: "G-Q08F6MFNCD"
};
        // ------------------------------------

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            
            window.fbFunctions = {
                signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, 
                createUserWithEmailAndPassword, onAuthStateChanged, signOut, 
                signInAnonymously, doc, setDoc, updateDoc, arrayUnion, 
                serverTimestamp, getDoc, collection, addDoc, onSnapshot
            };
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { font-family: 'Assistant', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .font-serif { font-family: 'Noto Serif Hebrew', serif; }
        .chat-container { height: 500px; display: flex; flex-direction: column; }
        @media (max-width: 768px) { .chat-container { height: calc(100vh - 200px); } }
        .preserve-lines { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- מקום להדבקת מפתח GEMINI API ---
        const apiKey = "AIzaSyB5Ah95TlVKK6CWyTnwCPd1Dv8ND5xKdBk"; 
        // ------------------------------------

        // --- רכיבים ותשתיות ---
        
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            });
            return <i data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className}></i>;
        };

        const cleanMarkdown = (text) => {
            if (!text) return "";
            return text.replace(/\*\*/g, '').replace(/###/g, '').replace(/#/g, '').replace(/json/g, '').replace(/```/g, '').trim();
        };

        const WRITING_LEVELS = {
            'elementary-school': { label: 'בית ספר יסודי (ד\'-ו\')', prompt: 'תכתוב ברמה של תלמיד בכיתה ו\' שמגיש עבודה ברמה גבוהה למורה.' },
            'middle-school': { label: 'חטיבת ביניים', prompt: 'כתוב בשפה תקנית, מכובדת ורצינית המתאימה לעבודת הגשה בחטיבת ביניים.' },
            'high-school': { label: 'תיכון', prompt: 'תכתוב ברמה של עבודה שמוגשת על ידי תלמידים בגיל 18 (עבודת גמר בתיכון).' },
            'academic': { label: 'אקדמי', prompt: 'כתוב בשפה אקדמית מלאה וגבוהה.' }
        };

        const INITIAL_DATA = {
            'תקציר': [{ id: 'abs-1', title: 'מטרת המחקר והרקע', rawInput: '', refinedContent: '' }, { id: 'abs-2', title: 'שאלת המחקר המרכזית', rawInput: '', refinedContent: '' }, { id: 'abs-3', title: 'מתודולוגיה בקצרה', rawInput: '', refinedContent: '' }, { id: 'abs-4', title: 'ממצאים ותרומת המחקר', rawInput: '', refinedContent: '' }],
            'מבוא': [{ id: 'intro-1', title: 'הצגת הנושא והקשר רחב', rawInput: '', refinedContent: '' }, { id: 'intro-2', title: 'סקירה היסטורית/חברתית קצרה', rawInput: '', refinedContent: '' }, { id: 'intro-3', title: 'חשיבות המחקר בעת הנוכחית', rawInput: '', refinedContent: '' }, { id: 'intro-4', title: 'שאלת המחקר והשערות', rawInput: '', refinedContent: '' }],
            'גוף העבודה': [{ id: 'body-1', title: 'סקירה תיאורטית וספרותית', rawInput: '', refinedContent: '' }, { id: 'body-2', title: 'טיעון מרכזי ראשון - ביסוס', rawInput: '', refinedContent: '' }, { id: 'body-3', title: 'ניתוח מקרה או דוגמה א׳', rawInput: '', refinedContent: '' }, { id: 'body-4', title: 'טיעון מרכזי שני - הרחבה', rawInput: '', refinedContent: '' }, { id: 'body-5', title: 'ניתוח מקרה או דוגמה ב׳', rawInput: '', refinedContent: '' }, { id: 'body-6', title: 'דיון ביקורתי ונקודות מבט שונות', rawInput: '', refinedContent: '' }, { id: 'body-7', title: 'אינטגרציה של הטיעונים', rawInput: '', refinedContent: '' }],
            'ממצאים': [{ id: 'res-1', title: 'תיאור הממצאים העיקריים', rawInput: '', refinedContent: '' }, { id: 'res-2', title: 'ניתוח נתונים (כמותי/איכותני)', rawInput: '', refinedContent: '' }, { id: 'res-3', title: 'השוואה בין השערות למציאות', rawInput: '', refinedContent: '' }, { id: 'res-4', title: 'משמעות הממצאים', rawInput: '', refinedContent: '' }],
            'סיכום': [{ id: 'conc-1', title: 'תמצית המסקנות', rawInput: '', refinedContent: '' }, { id: 'conc-2', title: 'מענה סופי לשאלת המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-3', title: 'מגבלות המחקר', rawInput: '', refinedContent: '' }, { id: 'conc-4', title: 'המלצות למחקר עתידי', rawInput: '', refinedContent: '' }],
            'ביבליוגרפיה': []
        };

        // --- מסכים ---

        const AuthScreen = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleGoogleSignIn = async () => {
                if(!window.fbFunctions) return;
                const provider = new window.fbFunctions.GoogleAuthProvider();
                try {
                    await window.fbFunctions.signInWithPopup(window.fbAuth, provider);
                } catch (err) { setError('שגיאה בהתחברות עם גוגל'); console.error(err); }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isRegistering) await window.fbFunctions.createUserWithEmailAndPassword(window.fbAuth, email, password);
                    else await window.fbFunctions.signInWithEmailAndPassword(window.fbAuth, email, password);
                } catch (err) { setError(isRegistering ? 'שגיאה בהרשמה' : 'שם משתמש או סיסמה שגויים'); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center relative overflow-hidden">
                        <div className="mb-6 flex justify-center"><Icon name="shield-check" size={48} className="text-indigo-600" /></div>
                        <h2 className="text-2xl font-black mb-2">ברוכים הבאים ל-ScholarBubbles</h2>
                        <p className="text-slate-500 mb-6 text-sm font-medium">כלי עזר מתקדם לכתיבת עבודות ומאמרים<br/>מבית <span className="text-indigo-600 font-bold">Toledano-edtech</span></p>
                        <button onClick={handleGoogleSignIn} className="w-full flex items-center justify-center gap-2 border p-3 rounded-xl hover:bg-slate-50 mb-4 font-bold">כניסה עם Google</button>
                        <form onSubmit={handleEmailAuth} className="space-y-3 text-right">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border" placeholder="אימייל" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border" placeholder="סיסמה" required />
                            {error && <p className="text-red-500 text-xs">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold hover:bg-indigo-700">
                                {loading ? 'טוען...' : (isRegistering ? 'הרשמה' : 'כניסה')}
                            </button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="mt-4 text-xs text-indigo-500 underline">{isRegistering ? 'יש לך חשבון? התחבר' : 'אין לך חשבון? הירשם'}</button>
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ user, onSelect, onLogout }) => (
            <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
                <div className="max-w-4xl w-full bg-white rounded-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden h-[80vh]">
                    <div className="md:w-1/2 bg-indigo-600 p-8 text-white flex flex-col justify-center items-center text-center">
                        <Icon name="book-open" size={48} className="mb-4" />
                        <h1 className="text-3xl font-black mb-2">ScholarBubbles</h1>
                        <p className="text-sm opacity-80">Toledano EdTech</p>
                        <div className="mt-4 text-xs bg-white/20 px-3 py-1 rounded-full">{user.email}</div>
                    </div>
                    <div className="md:w-1/2 p-8 flex flex-col justify-center bg-white overflow-y-auto">
                        <h2 className="text-xl font-bold mb-6 text-center text-slate-800">בחר/י רמת כתיבה:</h2>
                        <div className="space-y-3">
                            {Object.entries(WRITING_LEVELS).map(([key, info]) => (
                                <button key={key} onClick={() => onSelect(key)} className="w-full text-right p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 flex justify-between group">
                                    <span className="font-bold text-slate-900">{info.label}</span>
                                    <Icon name="chevron-left" className="text-slate-300 group-hover:text-indigo-500" />
                                </button>
                            ))}
                        </div>
                        <button onClick={onLogout} className="mt-8 text-sm text-slate-400 hover:text-red-500 flex items-center justify-center gap-1"><Icon name="log-out" size={14}/> התנתק</button>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(null);
            const [view, setView] = useState('מבוא'); 
            const [paperTitle, setPaperTitle] = useState('כותרת העבודה שלך');
            const [allData, setAllData] = useState(INITIAL_DATA);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [saveStatus, setSaveStatus] = useState('saved'); 
            
            const [questionChatMessages, setQuestionChatMessages] = useState([]);
            const [sourceChatMessages, setSourceChatMessages] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [showMobilePreview, setShowMobilePreview] = useState(false);

            const sections = ['תקציר', 'מבוא', 'גוף העבודה', 'ממצאים', 'סיכום', 'ביבליוגרפיה'];

            useEffect(() => {
                const checkFirebase = () => {
                    if (window.fbFunctions) {
                        window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                            setUser(u);
                            setLoadingAuth(false);
                            if (u) loadUserData(u.uid);
                        });
                    } else {
                        window.addEventListener('firebase-ready', () => {
                            window.fbFunctions.onAuthStateChanged(window.fbAuth, (u) => {
                                setUser(u);
                                setLoadingAuth(false);
                                if (u) loadUserData(u.uid);
                            });
                        });
                    }
                };
                checkFirebase();
            }, []);

            useEffect(() => {
                if (!user) return;
                const timeoutId = setTimeout(() => saveUserData(), 2000);
                return () => clearTimeout(timeoutId);
            }, [allData, paperTitle, level]);

            const loadUserData = async (uid) => {
                try {
                    const docRef = window.fbFunctions.doc(window.fbDb, "users", uid, "projects", "current");
                    const docSnap = await window.fbFunctions.getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.allData) setAllData(data.allData);
                        if (data.paperTitle) setPaperTitle(data.paperTitle);
                        if (data.level) setLevel(data.level);
                    }
                } catch (e) { console.error("Load Error:", e); }
            };

            const saveUserData = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    await window.fbFunctions.setDoc(window.fbFunctions.doc(window.fbDb, "users", user.uid, "projects", "current"), {
                        paperTitle, allData, level, lastUpdated: window.fbFunctions.serverTimestamp()
                    }, { merge: true });
                    setSaveStatus('saved');
                } catch (e) {
                    console.error("Save Error:", e);
                    setSaveStatus('error');
                }
            };

            const handleRefine = async (id) => {
                const bubble = allData[view].find(x => x.id === id);
                if (!bubble.rawInput.trim()) return;

                const newData = {...allData};
                newData[view] = newData[view].map(b => b.id === id ? { ...b, isRefining: true } : b);
                setAllData(newData);

                const isBib = view === 'ביבליוגרפיה';
                let prompt = isBib 
                    ? `עצב כציטוט ביבליוגרפי תקני: "${bubble.rawInput}". החזר רק את הציטוט.`
                    : `הנושא: ${paperTitle}. פרק: ${view}. רמה: ${WRITING_LEVELS[level].prompt}. מידע גולמי: "${bubble.rawInput}". כתוב פסקה מלאה ורציפה (ללא פתיחים/סיומות).`;

                try {
                    if (!apiKey) throw new Error("Missing API Key");
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const json = await res.json();
                    const text = json.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    const finalData = {...allData};
                    finalData[view] = finalData[view].map(b => b.id === id ? { ...b, refinedContent: cleanMarkdown(text), isRefining: false } : b);
                    setAllData(finalData);
                } catch (e) {
                    console.error(e);
                    alert("שגיאה בתקשורת עם ה-AI. וודא שהכנסת API Key תקין.");
                    const errData = {...allData};
                    errData[view] = errData[view].map(b => b.id === id ? { ...b, isRefining: false } : b);
                    setAllData(errData);
                }
            };

            const downloadAsWord = () => {
                const content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='[http://www.w3.org/TR/REC-html40](http://www.w3.org/TR/REC-html40)'><head><meta charset='utf-8'><title>${paperTitle}</title>
                <style>body{direction:rtl;text-align:right;font-family:'David',serif;font-size:12pt;line-height:1.5;margin:2.54cm}h1{text-align:center;font-size:16pt;font-weight:bold;margin-bottom:24pt}h2{font-size:14pt;font-weight:bold;margin-top:18pt;border-bottom:1px solid #000}p{margin-bottom:12pt;text-align:justify}</style></head><body>
                <h1>${paperTitle}</h1>
                ${sections.map(sec => {
                    const content = allData[sec].filter(b => b.refinedContent).map(b => `<p>${b.refinedContent.replace(/\n/g, '<br>')}</p>`).join('');
                    return content ? `<h2>${sec}</h2>${content}` : '';
                }).join('')}
                </body></html>`;
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${paperTitle}.doc`;
                a.click();
            };

            const AIChat = ({ type, messages, setMessages, title }) => {
                const [input, setInput] = useState('');
                const [loading, setLoading] = useState(false);
                const scrollRef = useRef(null);
                
                useEffect(() => { if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

                const send = async () => {
                    if (!input.trim() || loading) return;
                    const newMsgs = [...messages, { role: 'user', text: input }];
                    setMessages(newMsgs);
                    setInput('');
                    setLoading(true);
                    
                    try {
                        if (!apiKey) throw new Error("Missing API Key");
                        const sysPrompt = type === 'search' ? 'חפש מקורות רלוונטיים והחזר רשימה עם כותרת ולינק [שם](url).' : 'עזור למשתמש לנסח שאלת מחקר.';
                        const tools = type === 'search' ? [{ google_search: {} }] : undefined;
                        
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: newMsgs.map(m => ({ role: m.role==='user'?'user':'model', parts: [{ text: m.text }] })), systemInstruction: { parts: [{ text: sysPrompt }] }, tools })
                        });
                        const json = await res.json();
                        let text = json.candidates?.[0]?.content?.parts?.[0]?.text || "שגיאה";
                        const grounding = json.candidates?.[0]?.groundingMetadata?.groundingAttributions;
                        if (grounding) text += "\n\nמקורות:\n" + grounding.map(g => g.web?.title ? `• [${g.web.title}](${g.web.uri})` : '').join('\n');
                        
                        setMessages([...newMsgs, { role: 'ai', text: cleanMarkdown(text) }]);
                    } catch (e) { setMessages([...newMsgs, { role: 'ai', text: "שגיאה. וודא API Key." }]); }
                    setLoading(false);
                };

                return (
                    <div className="chat-container bg-white rounded-2xl border flex flex-col h-full shadow-sm">
                        <div className="p-4 border-b bg-slate-50 font-bold text-indigo-600 flex items-center gap-2"><Icon name={type==='search'?'search':'help-circle'}/> {title}</div>
                        <div className="flex-1 p-4 overflow-y-auto bg-slate-50" ref={scrollRef}>
                            {messages.map((m, i) => (
                                <div key={i} className={`flex mb-4 ${m.role === 'user' ? 'justify-start' : 'justify-end'}`}>
                                    <div className={`p-3 rounded-2xl max-w-[85%] text-sm whitespace-pre-wrap ${m.role === 'user' ? 'bg-white border' : 'bg-indigo-100 text-indigo-900'}`}>
                                        {m.text.split('\n').map((l, idx) => {
                                            const link = l.match(/\[(.*?)\]\((.*?)\)/);
                                            return link ? <div key={idx}><a href={link[2]} target="_blank" className="text-blue-600 underline font-bold">{link[1]}</a></div> : <div key={idx}>{l}</div>;
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-2">
                            <input className="flex-1 p-2 border rounded-full text-sm outline-none" value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder="הקלד כאן..." />
                            <button onClick={send} disabled={loading} className="bg-indigo-600 text-white p-2 rounded-full"><Icon name="send" size={16} /></button>
                        </div>
                    </div>
                );
            };

            if (loadingAuth) return <div className="flex h-screen items-center justify-center text-indigo-600 font-bold">טוען מערכת...</div>;
            if (!user) return <AuthScreen onAuthSuccess={setUser} />;
            if (!level) return <WelcomeScreen user={user} onSelect={setLevel} onLogout={() => window.fbFunctions.signOut(window.fbAuth)} />;

            return (
                <div className="flex h-screen overflow-hidden flex-col md:flex-row bg-slate-50 font-sans" dir="rtl">
                    {/* Header Mobile */}
                    <div className="md:hidden p-4 bg-slate-900 text-white flex justify-between items-center shadow-md z-50">
                        <div className="font-bold flex items-center gap-2"><Icon name="book-open" size={20} /> ScholarBubbles</div>
                        <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><Icon name={mobileMenuOpen ? "x" : "menu"} /></button>
                    </div>

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 right-0 z-40 w-64 bg-slate-900 text-white p-6 transform transition-transform duration-300 ${mobileMenuOpen ? 'translate-x-0' : 'translate-x-full'} md:relative md:translate-x-0 md:block shadow-xl`}>
                        <div className="mb-8 cursor-pointer" onClick={() => setLevel(null)}>
                            <h1 className="text-xl font-bold flex items-center gap-3"><Icon name="book-open" className="text-indigo-400" /> ScholarBubbles</h1>
                            <div className="text-[10px] mt-2 bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded inline-block">רמת {WRITING_LEVELS[level].label}</div>
                        </div>
                        <nav className="space-y-1">
                            <button onClick={() => {setView('question'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-2 flex items-center gap-2 ${view === 'question' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="help-circle" size={14}/> שאלת מחקר AI</button>
                            <button onClick={() => {setView('search'); setMobileMenuOpen(false);}} className={`w-full text-right p-3 rounded-xl text-sm mb-6 flex items-center gap-2 ${view === 'search' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Icon name="search" size={14}/> חיפוש מקורות AI</button>
                            {sections.map(s => (
                                <button key={s} onClick={() => {setView(s); setMobileMenuOpen(false);}} className={`w-full text-right p-2 rounded text-sm transition-all ${view === s ? 'bg-indigo-600 font-bold' : 'hover:bg-slate-800 text-slate-300'}`}>{s}</button>
                            ))}
                        </nav>
                        <div className="mt-auto pt-4 border-t border-slate-800">
                             <div className="text-[10px] text-slate-500 mb-1 truncate">{user.email}</div>
                             <div className={`text-[10px] font-bold ${saveStatus==='error'?'text-red-400':'text-emerald-400'}`}>{saveStatus==='saving'?'שומר...':saveStatus==='error'?'שגיאת שמירה (בדוק Rules)':'הכל נשמר'}</div>
                             <button onClick={downloadAsWord} className="w-full mt-4 bg-emerald-600 text-white p-3 rounded-xl text-xs font-bold flex justify-center gap-2 hover:bg-emerald-700"><Icon name="download" size={14} /> הורד Word</button>
                        </div>
                    </aside>

                    {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setMobileMenuOpen(false)} />}

                    <main className="flex-1 flex overflow-hidden relative">
                        <section className={`flex-1 p-6 md:p-10 overflow-y-auto ${showMobilePreview ? 'hidden md:block' : 'block'}`}>
                            <div className="max-w-3xl mx-auto pb-20">
                                <input className="w-full bg-transparent text-2xl font-black mb-6 border-b-2 border-transparent focus:border-indigo-500 outline-none" value={paperTitle} onChange={e=>setPaperTitle(e.target.value)} />
                                
                                {view === 'question' ? <AIChat type="question" title="גיבוש שאלת מחקר" messages={questionChatMessages} setMessages={setQuestionChatMessages} /> :
                                 view === 'search' ? <AIChat type="search" title="חיפוש מקורות" messages={sourceChatMessages} setMessages={setSourceChatMessages} withSearchTool={true} /> :
                                 (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-3xl font-black text-slate-800">{view}</h2>
                                            <button className="md:hidden bg-slate-200 px-3 py-1 rounded text-sm" onClick={() => setShowMobilePreview(true)}>תצוגה</button>
                                        </div>
                                        {allData[view]?.map(b => (
                                            <div key={b.id} className="bg-white p-6 rounded-2xl shadow-sm border mb-6">
                                                <input className="font-bold text-indigo-600 bg-transparent outline-none w-full mb-2 block" value={b.title} onChange={e=>{
                                                    const newData = {...allData}; newData[view] = newData[view].map(i => i.id === b.id ? {...i, title: e.target.value} : i); setAllData(newData);
                                                }} />
                                                <textarea className="w-full p-3 bg-slate-50 rounded-xl min-h-[100px] text-sm mb-4 outline-none border focus:border-indigo-300" value={b.rawInput} onChange={e=>{
                                                    const newData = {...allData}; newData[view] = newData[view].map(i => i.id === b.id ? {...i, rawInput: e.target.value} : i); setAllData(newData);
                                                }} placeholder="כתוב כאן נקודות..." />
                                                <div className="flex justify-end">
                                                    <button onClick={() => handleRefine(b.id)} disabled={b.isRefining} className="bg-indigo-600 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 disabled:opacity-50">
                                                        {b.isRefining ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="wand-2" />} 
                                                        {view === 'ביבליוגרפיה' ? 'עצב מקור' : 'עבד פסקה'}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={()=>{
                                            const newData = {...allData}; newData[view].push({id: Date.now(), title: 'פסקה חדשה', rawInput: '', refinedContent: ''}); setAllData(newData);
                                        }} className="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold hover:border-indigo-500 hover:text-indigo-500 flex justify-center gap-2"><Icon name="plus"/> הוסף בועה</button>
                                    </div>
                                )}
                            </div>
                        </section>

                        <section className={`w-full md:w-[45%] bg-white p-12 overflow-y-auto border-r shadow-inner ${showMobilePreview ? 'block fixed inset-0 z-50' : 'hidden md:block'}`}>
                            {showMobilePreview && <button onClick={() => setShowMobilePreview(false)} className="absolute top-4 left-4 bg-slate-200 p-2 rounded-full md:hidden"><Icon name="x" /></button>}
                            <div className="max-w-[21cm] mx-auto min-h-[29.7cm] font-serif text-right" dir="rtl">
                                <h3 className="text-center font-bold border-b-2 border-black pb-4 mb-8 text-2xl">{paperTitle}</h3>
                                {sections.map(sec => (
                                    allData[sec].some(b => b.refinedContent) &&
                                    <div key={sec} className="mb-8">
                                        <h4 className="font-bold text-lg mb-4 underline">{sec}</h4>
                                        {allData[sec].map(b => b.refinedContent && <p key={b.id} className="text-[12pt] leading-[1.5] mb-4 text-justify preserve-lines">{b.refinedContent}</p>)}
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
